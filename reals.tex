\chapter{Real numbers}
\label{cha:real-numbers}

Any foundation of mathematics worthy of its name must eventually address the construction
of real numbers as understood by mathematical analysis, namely as a complete archimedean
ordered field. Completeness can be understood either in the sense of Cauchy or Dedekind.
In this chapter we shall look at both, Dedekind's construction of reals as cuts, and
Cauchy reals as completion of rational numbers by limits of Cauchy sequences.

It is worth pointing out that the total space of the universal cover of the circle, which
in \autoref{subsec:pi1s1-homotopy-theory} played a role similar to ``the real numbers'' in
classical algebraic topology, is \emph{not} the type of reals we are looking for. That
type is contractible, and thus equivalent to the singleton type, so it cannot be equipped
with a non-trivial algebraic structure.


\section{The field of rational numbers}
\label{sec:field-rati-numb}
\index{rational numbers}

We first construct the rational numbers \Q, as the reals can then be seen as a completion
of~\Q. An expert will point out that \Q could be replaced by any approximate field, i.e.,
a subring of \Q in which arbitrarily precise approximate inverses exist. An example is the
ring of dyadic rationals, which are those of the form $n/2^k$. 
If we were implementing constructive mathematics on a computer,
an approximate field would be more suitable, but we leave such finesse for those
who care about the digits of~$\pi$.

We constructed the integers \Z in \autoref{sec:set-quotients} as a quotient of $\N\times
\N$, and observed that this quotient is generated by an idempotent. In
\autoref{sec:free-algebras} we saw that \Z is the free group on \unit; we could similarly
show that it is the free commutative ring on \emptyt. The field of rationals \Q is
constructed along the same lines as well, namely as the quotient
%
\[ \Q \defeq (\Z \times \N)/{\approx} \]
%
where
\[ (u,a) \approx (v,b) \defeq (u (b + 1) = v (a + 1)). \]
%
In other words, a pair $(u, a)$ represents the rational number $u / (1 + a)$. There can be
no division by zero because we cunningly added one to the denominator~$a$. Here too we
have a canonical choice of representatives, namely fractions in lowest terms. Thus we may
apply \autoref{lem:quotient-when-canonical-representatives} to obtain a set \Q, which
again has a decidable equality.

We do not bother to write down the arithmetical operations on \Q as we trust our readers
know how to compute with fractions even in the case when one is added to the denominator.
Let us just record the conclusion that there is an entirely unproblematic construction of
the ordered field of rational numbers \Q, with a decidable equality and decidable order.
It can also be characterized as the initial ordered field.

Let $\Qp = \setof{ q : \Q | q > 0 }$ be the type of positive rational numbers.

\section{Dedekind reals}
\label{sec:dedekind-reals}

Let us first recall the basic idea of Dedekind's construction. We use two-sided Dedekind
cuts, as opposed to an often used one-sided version, because the symmetry makes
constructions more elegant, and it works constructively as well as classically. A
\emph{Dedekind cut} consists of a pair $(L, U)$ of subsets $L, U \subseteq \Q$, called the
\emph{lower} and \emph{upper cut} respectively, which are:
% 
\begin{enumerate}
\item \emph{inhabited}: there are $q \in L$ and $r \in U$,
\item \emph{rounded:} $q \in L \Leftrightarrow \exis {r \in \Q} q < r \in L$
  and $r \in U \Leftrightarrow \exis {q \in \Q} U \ni q < r$,
\item \emph{disjoint:} $\lnot (q \in L \land q \in U)$, and
\item \emph{located:} $q < r \Rightarrow q \in L \lor r \in U$.
\end{enumerate}
%
Reading the roundedness condition from left to right tells us that cuts are \emph{open},
and from right to left that they are \emph{lower}, respectively \emph{upper}, sets. The
locatedness condition states that there is no large gap between $L$ and $U$. Because cuts
are always open, they never include the ``point in between'', even when it is rational. A
typical Dedekind cut looks like this:
%
\begin{center}
  \begin{tikzpicture}
    \draw[<-),line width=0.75pt] (0,0) -- (3.99,0) node[anchor=south east]{$L\ $};
    \draw[(->,line width=0.75pt] (4.01, 0) node[anchor=south west]{$\ U$} -- (14, 0) ;
  \end{tikzpicture}
\end{center}
%
We might naively translate the informal definition into type theory by saying that a cut
is a pair of maps $L, U : \Q \to \prop$. But we saw in \autoref{subsec:prop-subsets} that
$\prop$ is an ambiguous notation for $\prop_{\UU_i}$ where~$\UU_i$ is a universe. Once we
use a particular $\UU_i$ to define cuts, the type of reals will reside in the next
universe $\UU_{i+1}$, a property of reals two levels higher in $\UU_{i+2}$, a property of
subsets of reals in $\UU_{i+3}$, etc. In principle we should be able to keep track of the
universe levels, especially with the help of a proof assistant, but doing so here would
just burden us with bureaucracy that we prefer to avoid. We shall therefore make a
simplifying assumption that a single type of propositions $\Omega$ is sufficient for all
our purposes.

In fact, the construction of the Dedekind reals is quite resilient to logical
manipulations. There are several ways in which we can make sense of using a single type
$\Omega$:
%
\begin{enumerate}

\item We could identify $\Omega$ with the ambiguous $\prop$ and track all the universes
  that appear in definitions and constructions.

\item We could assume impredicativity of mere propositions, cf.\
  \autoref{subsec:prop-subsets}, which essentially collapses the $\prop_{\UU_i}$'s to the
  lowest level, which we call $\Omega$.

\item A classical mathematician who is not interested in the intricacies of type-theoretic
  universes or computation may simply assume the law of excluded middle~\eqref{eq:lem} for
  mere propositions so that $\Omega \jdeq \bool$. This not only eradicates questions about
  levels of $\prop$, but also turns everything we do into the standard classical
  construction of real numbers. We demonstrate this point further in
  \autoref{sec:compactness-interval}.

\item On the other end of the spectrum one might ask for a minimal requirement that makes
  the constructions work. The condition that a mere predicate be a Dedekind cut is
  expressible using only conjunctions, disjunctions, and existential quantifiers over~\Q, which
  is a countable set. Thus we could take $\Omega$ to be the initial \emph{$\sigma$-frame},
  i.e., a lattice with countable joins in which binary meets distribute over countable
  joins. (The initial $\sigma$-frame cannot be the two-point lattice $\bool$ because
  $\bool$ is not closed under countable joins, unless we assume excluded middle.) This
  would lead to a construction of~$\Omega$ as a higher inductive-inductive type, but one
  experiment of this kind in \autoref{sec:cauchy-reals} is enough.
\end{enumerate}

In all of the above cases $\Omega$ is a set.
%
Without further ado, we translate the informal definition into type theory.
Throughout this chapter, we use the
logical notation from \autoref{defn:logical-notation}.

\begin{defn} \label{defn:dedekind-reals}
  A \define{Dedekind cut} is a pair $(L, U)$ of mere predicates $L : \Q \to \Omega$ and $U
  : \Q \to \Omega$ which is:
  %
  \begin{enumerate}
  \item \emph{inhabited}: $\exis{q : \Q} L(q)$ and $\exis{r : Q} U(r)$,
  \item \emph{rounded:} for all $q, r : \Q$,
    %
    \begin{equation*}
      L(q) \Leftrightarrow \exis{r : \Q} (q < r) \land L(r)
      \quad\text{and}\quad
      U(r) \Leftrightarrow \exis{q : \Q} (q < r) \land U(q),
    \end{equation*}
  \item \emph{disjoint:} $\lnot (L(q) \land U(q))$ for all $q : \Q$,
  \item \emph{located:} $(q < r) \Rightarrow L(q) \lor U(r)$ for all $q, r : \Q$.
  \end{enumerate}
  %
  We let $\dcut(L, U)$ denote the conjunction of these conditions. The type of
  \define{Dedekind reals} is
  %
  \begin{equation*}
    \RD \defeq \setof{ (L, U) : (\Q \to \Omega) \times (\Q \to \Omega) | \dcut(L,U)}.
  \end{equation*}
\end{defn}

It is apparent that $\dcut(L, U)$ is a mere proposition, and since $\Q \to \Omega$ is a
set the Dedekind reals form a set too. See
\autoref{ex:RD-extended-reals,ex:RD-lower-cuts,ex:RD-interval-arithmetic} for variants of
Dedekind cuts which lead to extended reals, lower and upper reals, and the interval
domain.

There is an embedding $\Q \to \RD$ which associates with each rational $q : \Q$ the cut
$(L_q, U_q)$ where
%
\begin{equation*}
  L_q(r) \defeq (r < q)
  \qquad\text{and}\qquad
  U_q(r) \defeq (q < r).
\end{equation*}
%
We shall simply write $q$ for the cut $(L_q, U_q)$ associated with a rational number.

\subsection{The algebraic structure of Dedekind reals}
\label{sec:algebr-struct-dedek}

The construction of the algebraic and order-theoretic structure of Dedekind reals proceeds
as usual in intuitionistic logic. Rather than dwelling on details we point out the
differences between the classical and intuitionistic setup. Writing $L_x$ and $U_x$ for
the lower and upper cut of a real number $x : \RD$, we define addition as%
%
\begin{align*}
  L_{x + y}(q) &\defeq \exis{r, s : \Q} L_x(r) \land L_y(s) \land q = r + s, \\
  U_{x + y}(q) &\defeq \exis{r, s : \Q} U_x(r) \land U_y(s) \land q = r + s
\end{align*}
%
and the additive inverse by
%
\begin{align*}
  L_{-x}(q) &\defeq \exis{r : \Q} U_x(r) \land q = - r, \\
  U_{-x}(q) &\defeq \exis{r : \Q} L_x(r) \land q = - r.
\end{align*}
%
With these operations $(\RD, 0, {+}, {-})$ is an abelian group. Multiplication is a bit
more cumbersome:
%
\begin{align*}
  L_{x \cdot y}(q) &\defeq
  \begin{aligned}[t]
    \exis{a, b, c, d : \Q} & L_x(a) \land U_x(b) \land L_y(c) \land U_y(d) \land {}\\
                           & \qquad q < \min (a \cdot c, a \cdot d, b \cdot c, b \cdot d),
  \end{aligned} \\
  U_{x \cdot y}(q) &\defeq
  \begin{aligned}[t]
    \exis{a, b, c, d : \Q} & L_x(a) \land U_x(b) \land L_y(c) \land U_y(d) \land {}\\
                           & \qquad \max (a \cdot c, a \cdot d, b \cdot c, b \cdot d) < q.
  \end{aligned}
\end{align*}
%
These formulas are related to multiplication of intervals in interval arithmetic, where
intervals $[a,b]$ and $[c,d]$ with rational endpoints multiply to the interval
%
\begin{equation*}
  [a,b] \cdot [c,d] =
  [\min(a c, a d, b c, b d), \max(a c, a d, b c, b d)].
\end{equation*}
%
For instance, the formula for the lower cut can be read as saying that $q < x \cdot y$
when there are intervals $[a,b]$ and $[c,d]$ containing $x$ and $y$, respectively, such
that $q$ is to the left of $[a,b] \cdot [c,d]$. It is generally useful to think of an
interval $[a,b]$ such that $L_x(a)$ and $U_x(b)$ as an approximation of~$x$, see
\autoref{ex:RD-interval-arithmetic}.

We now have a commutative ring with unit $(\RD, 0, 1, {+}, {-}, {\cdot})$. To treat
multiplicative inverses, we must first introduce order. Define $\leq$ and $<$ as
%
\begin{align*}
  (x \leq y) &\ \defeq \ \fall{q : \Q} L_x(q) \Rightarrow L_y(q), \\
  (x < y)    &\ \defeq \ \exis{q : \Q} U_x(q) \land L_y(q).
\end{align*}

\begin{lem} \label{dedekind-in-cut-as-le}
  For all $x : \RD$ and $q, r : \Q$, $L_x(q) \Leftrightarrow (q < x)$ and $U_x(r)
  \Leftrightarrow (x < r)$.
\end{lem}

\begin{proof}
  If $L_x(q)$ then by roundedness there merely is $r > q$ such that $L_x(r)$, and since
  $U_q(r)$ it follows that $q < x$. Conversely, if $q < x$ then there is $r : \Q$ such
  that $U_q(r)$ and $L_x(r)$, hence $L_x(q)$ because $L_x$ is a lower set. The other half
  of the proof is symmetric.
\end{proof}

The relation $\leq$ is a partial order, and $<$ is transitive and irreflexive. The
trichotomy law
%
\begin{equation*}
  (x < y) \lor (x = y) \lor (y < x)
\end{equation*}
%
is valid if we assume excluded middle, but without it we get the intuitionistic version
%
\begin{equation} \label{eq:RD-linear-order}
  (x < y) \Rightarrow (x < z) \lor (z < y).
\end{equation}
%
To see this, suppose $x < y$. Then there merely exists $q : \Q$ such that $U_x(q)$ and
$L_y(q)$. By roundedness there merely exist $r, s : \Q$ such that $r < q < s$, $U_x(r)$
and $L_y(s)$. Then, by locatedness $L_z(r)$ or $U_z(s)$. In the first case we get $x < z$
and in the second $z < y$. At first sight it might not be clear
what~\eqref{eq:RD-linear-order} has to do with the linear order. But if we take $x \jdeq
u - \epsilon$ and $y \jdeq u + \epsilon$ for $\epsilon > 0$, then we get
%
\begin{equation*}
  (u - \epsilon < z) \lor (z < u + \epsilon).
\end{equation*}
%
This is linear order ``up to a small numerical error'', i.e., since it is unreasonable to
expect that we can actually compute with infinite precision, we should not be surprised
that we can decide~$<$ only up to whatever finite precision we have computed.

Classically, multiplicative inverses exist for all numbers which are different from zero.
However, without excluded middle, a stronger condition is required. Say that $x, y : \RD$
are \define{apart} from each other, written $x \apart y$, when $(x < y) \lor (y < x)$:
%
\begin{equation*}
  (x \apart y) \defeq (x < y) \lor (y < x).
\end{equation*}
%
If $x \apart y$, then $\lnot (x = y)$.
The converse is true if we assume excluded middle, but is not provable constructively.
Indeed, if $\lnot (x = y)$ implies $x\apart y$, then a little bit of excluded middle follows; see \autoref{ex:reals-apart-neq-MP}.

\begin{thm} \label{RD-inverse-apart-0}
  A real is invertible if, and only if, it is apart from $0$.
\end{thm}

\begin{rmk}
  We observe that a real is invertible if, and only if, it is merely
  invertible.  Indeed, the same is true in any ring, since a ring is a set, and
  multiplicative inverses are unique if they exist.  See the discussion
  following \autoref{cor:UC}.
\end{rmk}

\begin{proof}
  Suppose $x \cdot y = 1$. Then there merely exist $a, b, c, d : \Q$ such that
  $a < x < b$, $c < y < d$ and $0 < \min (a c, a d, b c, b d)$. From $0 < a c$ it follows
  that $0 < a < x < c$ or $a < x < c < 0$, hence $x \apart 0$.

  Conversely, if $x \apart 0$ then
  %
  \begin{align*}
    L_{x^{-1}}(q) &\defeq
    \exis{r : \Q} U_x(r) \land ((0 < r \land q r < 1) \lor (r < 0 \land 1 < q r))
    \\
    U_{x^{-1}}(q) &\defeq
    \exis{r : \Q} L_x(r) \land ((0 < r \land q r > 1) \lor (r < 0 \land 1 > q r))
  \end{align*}
  %
  defines the desired inverse. Indeed, $L_{x^{-1}}$ and $U_{x^{-1}}$ are bounded because
  $x \apart 0$.
\end{proof}

The archimedean principle can be stated in several ways. We find it most illuminating in the
form which says that $\Q$ is dense in $\RD$.

\begin{thm}[Archimedean principle for $\RD$] \label{RD-archimedean}
  %
  For all $x, y : \RD$ if $x < y$ then there merely exists $q : \Q$ such that
  $x < q < y$.
\end{thm}

\begin{proof}
  By definition of $<$.
\end{proof}

Before tackling completeness of Dedekind reals, let us state precisely what algebraic
structure they possess. In the following definition we are not aiming at a minimal
axiomatization, but rather at a useful amount of structure and properties.

\begin{defn} \label{ordered-field} An \define{ordered field} is a set $F$ together with
  constants $0$, $1$, operations $+$, $-$, $\cdot$, $\min$, $\max$, and mere relations
  $\leq$, $<$, $\apart$ such that:
  %
  \begin{enumerate}
  \item $(F, 0, 1, {+}, {-}, {\cdot})$ is a commutative ring with unit;
  \item $x : F$ is invertible if, and only if $x \apart 0$;
  \item $(F, {\leq}, {\min}, {\max})$ is a lattice;
  \item the strict order $<$ is transitive, irreflexive, and linear ($x < y \Rightarrow x < z \lor z < y$);
  \item apartness $\apart$ is reflexive, symmetric and cotransitive ($x \apart y \Rightarrow x \apart z \lor y \apart z$);
  \item for all $x, y, z : F$:
    %
    \begin{align*}
      x \leq y &\Leftrightarrow \lnot (y < x), &
      x < y \leq z &\Rightarrow x < z, \\
      x \apart y &\Leftrightarrow (x < y) \lor (y < x), &
      x \leq y < z &\Rightarrow x < z, \\
      x \leq y &\Leftrightarrow x + z \leq y + z, &
      x \leq y \land 0 \leq z &\Rightarrow x z \leq y z, \\
      x < y &\Leftrightarrow x + z < y + z, &
      0 < z &\Rightarrow (x < y \Leftrightarrow x z < y z), \\
      0 < x + y &\Rightarrow 0 < x \lor 0 < y, &
      0 &< 1.
    \end{align*}
  \end{enumerate}
  %
  Every such field has a canonical embedding $\Q \to F$. An ordered field is
  \define{archimedean} when for all $x, y : F$, if $x < y$ then there merely exists $q :
  \Q$ such that $x < q < y$.
\end{defn}

\begin{thm} \label{RD-archimedean-ordered-field}
  The Dedekind reals form an ordered archimedean field.
\end{thm}

\begin{proof}
  We omit the proof in the hope that what we have demonstrated so far makes the theorem
  plausible.
\end{proof}

\subsection{Dedekind reals are Cauchy complete}
\label{sec:RD-cauchy-complete}

Recall that $x : \N \to \Q$ is a \emph{Cauchy sequence} when it satisfies
%
\begin{equation} \label{eq:cauchy-sequence}
  \prd{\epsilon : \Qp} \sm{n : \N} \prd{m, k \geq n} |x_m - x_k| < \epsilon.
\end{equation}
%
Note that we did \emph{not} truncate the inner existential because we actually want to
compute rates of convergence---an approximation without an error estimate carries little
useful information. By \autoref{thm:ttac}, \eqref{eq:cauchy-sequence} yields a function $M
: \Qp \to \N$, called the \emph{modulus of convergence}, such that $m, k \geq M(\epsilon)$
implies $|x_m - x_k| < \epsilon$. From this we get $|x_{M(\delta/2)} - x_{M(\epsilon/2)}|<
\delta + \epsilon$ for all $\epsilon : \Qp$. In fact, the map $(\epsilon \mapsto
x_{M(\epsilon/2)}) : \Qp \to \Q$ carries the same information about the limit as the
original Cauchy condition~\eqref{eq:cauchy-sequence}. We shall work with these
approximation functions rather than with Cauchy sequences.

\begin{defn} \label{defn:cauchy-approximation}
  A \define{Cauchy approximation} is a map $x : \Qp \to \RD$ which satisfies
  %
  \begin{equation}
    \label{eq:cauchy-approx}
    \fall{\delta, \epsilon :\Qp} |x_\delta - x_\epsilon| < \delta + \epsilon.
  \end{equation}
  %
  The \define{limit} of a Cauchy approximation $x : \Qp \to \RD$ is a number $\ell : \RD$ such
  that
  % 
  \begin{equation*}
    \fall{\epsilon, \theta : \Qp} |x_\epsilon - \ell| < \epsilon + \theta.
  \end{equation*}
\end{defn}

\begin{thm} \label{RD-cauchy-complete}
  Every Cauchy approximation in $\RD$ has a limit.
\end{thm}

\begin{proof}
  Note that we are showing existence, not mere existence, of the limit.
  Given a Cauchy approximation $x : \Qp \to \RD$, define
  % 
  \begin{align*}
    L_y(q) &\defeq \exis{\epsilon, \theta : \Qp} L_{x_\epsilon}(q + \epsilon + \theta),\\
    U_y(q) &\defeq \exis{\epsilon, \theta : \Qp} U_{x_\epsilon}(q - \epsilon - \theta).
  \end{align*}
  %
  It is clear that $L_y$ and $U_y$ are bounded, rounded, and disjoint. To establish
  locatedness, consider any $q, r : \Q$ such that $q < r$. There is $\epsilon : \Qp$ such
  that $5 \epsilon < r - q$. Since $q + 2 \epsilon < r - 2 \epsilon$ merely
  $L_{x_\epsilon}(q + 2 \epsilon)$ or $U_{x_\epsilon}(r - 2 \epsilon)$. In the first case
  we have $L_y(q)$ and in the second $U_y(r)$.

  To show that $y$ is the limit of $x$, consider any $\epsilon, \theta : \Qp$. Because
  $\Q$ is dense in $\RD$ there merely exist $q, r : \Q$ such that
  %
  \begin{equation*}
    x_\epsilon - \epsilon - \theta/2 < q < x_\epsilon - \epsilon - \theta/4
    < x_\epsilon <
    x_\epsilon + \epsilon + \theta/4 < r < x_\epsilon + \epsilon + \theta/2,
  \end{equation*}
  % 
  and thus $q < y < r$. Now either $y < x_\epsilon + \theta/2$ or $x_\epsilon - \theta/2 < y$.
  In the first case we have
  %
  \begin{equation*}
    x_\epsilon - \epsilon - \theta/2 < q < y < x_\epsilon + \theta/2,
  \end{equation*}
  %
  and in the second
  %
  \begin{equation*}
    x_\epsilon - \theta/2 < y < r < x_\epsilon + \epsilon + \theta/2.
  \end{equation*}
  %
  In either case it follows that $|y - x_\epsilon| < \epsilon + \theta$.
\end{proof}

For sake of completeness we record the classic formulation as well.

\begin{cor}
  Suppose $x : \N \to \RD$ satisfies the Cauchy condition~\eqref{eq:cauchy-sequence}. Then
  there exists $y : \RD$ such that
  %
  \begin{equation*}
    \prd{\epsilon : \Qp} \sm{n : \N} \prd{m \geq n} |x_m - y| < \epsilon.
  \end{equation*}
\end{cor}

\begin{proof}
  By \autoref{thm:ttac} there is $M : \Qp \to \N$ such that $\bar{x}(\epsilon) \defeq
  x_{M(\epsilon/2)}$ is a Cauchy approximation. Let $y$ be its limit, which exists by
  \autoref{RD-cauchy-complete}. Given any $\epsilon : \Qp$, let $n \defeq M(\epsilon/4)$
  and observe that, for any $m \geq n$,
  %
  \begin{equation*}
    |x_m - y| \leq |x_m - x_n| + |x_n - y| =
    |x_m - x_n| + |\bar{x}(\epsilon/2) - y| <
    \epsilon/4 + \epsilon/2 + \epsilon/4 = \epsilon.\qedhere
  \end{equation*}
\end{proof}

\subsection{Dedekind reals are Dedekind complete}
\label{sec:RD-dedekind-complete}

We obtained $\RD$ as the type of Dedekind cuts on $\Q$. But we could have instead started
with any archimedean ordered field $F$ and constructed Dedekind cuts on $F$. These would
again form an archimedean ordered field $\bar{F}$, the \define{Dedekind completion of
  $F$}, with $F$ contained as a subfield. What happens if we apply this construction to
$\RD$, do we get even more real numbers? The answer is negative. In fact, we shall prove a
stronger results.

Say that an ordered field~$F$ is \define{admissible for $\Omega$} when the strict order
$<$ on~$F$ is a map ${<} : F \to F \to \Omega$.

\begin{thm} \label{RD-final-field}
  Every archimedean ordered field which is admissible for $\Omega$ is a subfield of~$\RD$.
\end{thm}

\begin{proof}
  Let $F$ be an archimedean ordered field. For every $x : F$ define $L, U : \Q \to
  \Omega$ by
  %
  \begin{equation*}
    L_x(q) \defeq (q < x)
    \qquad\text{and}\qquad
    U_x(q) \defeq (x < q).
  \end{equation*}
  %
  (We have just used the assumption that $F$ is admissible for $\Omega$.)
  Then $(L_x, U_x)$ is a Dedekind cut. Indeed, the cuts are inhabited and rounded because
  $F$ is archimedean and $<$ is transitive, disjoint because $<$ is irreflexive, and
  located because $<$ is a linear order. Let $e : F \to \RD$ be the map $e(x) \defeq (L_x,
  U_x)$.

  We claim that $e$ is a field embedding which preserves and reflects the order. First of
  all, notice that $e(q) = q$ for a rational number $q$. Next we have the equivalences,
  for all $x, y : F$,
  %
  \begin{equation*}
    x < y \Leftrightarrow
    (\exis{q : \Q} x < q < y) \Leftrightarrow
    (\exis{q : \Q} U_x(q) \land L_y(q)) \Leftrightarrow
    e(x) < e(y),
  \end{equation*}
  %
  so $e$ indeed preserves and reflects the order. That $e(x + y) = e(x) + e(y)$ holds
  because, for all $q : \Q$,
  %
  \begin{equation*}
    q < x + y \Leftrightarrow
    \exis{r, s : \Q} r < x \land s < y \land q = r + s.
  \end{equation*}
  %
  The implication from right to left is obvious. For the other direction, if $q < x +
  y$ then there merely exists $r : \Q$ such that $q - y < r < x$, and by taking $s \defeq
  q - r$ we get the desired $r$ and $s$. We leave preservation of multiplication by $e$ as
  an exercise.
\end{proof}

To establish that the Dedekind cuts on $\RD$ do not give us anything new, we need just one
more lemma.

\begin{lem} \label{lem:cuts-preserve-admissibility}
  If $F$ is admissible for $\Omega$ then so is its Dedekind completion.
\end{lem}

\begin{proof}
  Let $\bar{F}$ be the Dedekind completion of $F$. The strict order on $\bar{F}$ is
  defined by
  %
  \begin{equation*}
    ((L,U) < (L',U')) \defeq \exis{q : \Q} U(q) \land L'(q).
  \end{equation*}
  %
  Since $U(q)$ and $L'(q)$ are elements of $\Omega$, the lemma holds as long as $\Omega$
  is closed under conjunctions and countable existentials, which we assumed from the outset.
\end{proof}


\begin{cor} \label{RD-dedekind-complete}
  %
  The Dedekind reals are Dedekind complete: for every real-valued Dedekind cut $(L, U)$
  there is a unique $x : \RD$ such that $L(y) = (y < x)$ and $U(y) = (x < y)$ for all $y :
  \RD$.
\end{cor}

\begin{proof}
  By \autoref{lem:cuts-preserve-admissibility} the Dedekind completion $\barRD$ of $\RD$
  is admissible for $\Omega$, so by \autoref{RD-final-field} we have an embedding $\barRD
  \to \RD$, as well as an embedding $\RD \to \barRD$. But these embeddings must be
  isomorphisms, because their compositions are order-preserving field homomorphisms which
  fix the dense subfield~$\Q$, which means that they are the identity. The corollary now
  follows immediately from the fact that $\barRD \to \RD$ is an isomorphism.
\end{proof}

\section{Cauchy reals}
\label{sec:cauchy-reals}

The Cauchy reals are, by intent, the completion of \Q under limits of Cauchy sequences.
In the classical construction of the Cauchy reals, we consider the set $\mathcal{C}$ of all Cauchy sequences in \Q and then form a suitable quotient $\mathcal{C}/{\approx}$.
Then, to show that $\mathcal{C}/{\approx}$ is Cauchy complete, we consider a Cauchy sequence $x : \N \to \mathcal{C}/{\approx}$, lift it to a sequence of sequences $\bar{x} : \N \to \mathcal{C}$, and construct the limit of $x$ using $\bar{x}$. However, the lifting of~$x$ to $\bar{x}$ uses
the Axiom of Countable Choice (the instance of~\eqref{eq:ac} where $X=\N$) or the law of excluded middle, which we may wish to avoid.
Every construction of reals whose last step is a quotient suffers from this deficiency.
There are three common ways out of the conundrum in constructive mathematics:
%
\begin{enumerate}
\item Pretend that the reals are a setoid $(\mathcal{C}, {\approx})$, i.e., the type of
  Cauchy approximations $\mathcal{C}$ with a coincidence relation attached to it by
  administrative decree. A sequence of reals then simply \emph{is} a sequence of Cauchy
  approximations representing them.
\item Give in to temptation and accept the Axiom of Countable Choice. After all, the axiom
  is valid in most models of constructive mathematics based on a computational viewpoint,
  such as realizability models.
\item Declare the Cauchy reals unworthy and construct the Dedekind reals instead.
  Such a verdict is perfectly valid in certain contexts, such as in sheaf-theoretic models of constructive mathematics.
  However, as we saw in \autoref{sec:dedekind-reals}, the constructive Dedekind reals have their own problems.
\end{enumerate}

Using higher inductive types, however, there is a fourth solution, which we believe to be preferable to any of the above, and interesting even to a classical mathematician.
The idea is that the Cauchy real numbers should be the \emph{free complete metric space} generated by~\Q.
In general, the construction of a free gadget of any sort requires applying the gadget operations repeatedly many times to the generators.
For instance, the elements of the free group on a set $X$ are not just binary products and inverses of elements of $X$, but words obtained by iterating the product and inverse constructions.
Thus, we might naturally expect the same to be true for Cauchy completion, with the relevant ``operation'' being ``take the limit of a Cauchy sequence''.
(In this case, the iteration would have to take place transfinitely, since even after infinitely many steps there will be new Cauchy sequences to take the limit of.)

The argument referred to above shows that if excluded middle or Countable Choice hold, then Cauchy completion is very special: when building the completion of a space, it suffices to stop applying the operation after \emph{one step}.
This may be regarded as analogous to the fact that free monoids and free groups can be given explicit descriptions in terms of (reduced) words.
However, we saw in \autoref{sec:free-algebras} that higher inductive types allow us to construct free gadgets \emph{directly}, whether or not there is also an explicit description available.
In this section we show that the same is true for the Cauchy reals (a similar technique would construct the Cauchy completion of any metric space).
Specifically, higher inductive types allow us to \emph{simultaneously} add limits of Cauchy sequences and quotient by the coincidence relation, so that we can avoid the problem of lifting a sequence of reals to a sequence of representatives.


\subsection{Construction of Cauchy reals}
\label{sec:constr-cauchy-reals}

The construction of the Cauchy reals $\RC$ as a higher inductive type is a bit more subtle than that of the free algebraic structures considered in \autoref{sec:free-algebras}.
We intend to include a ``take the limit'' constructor whose input is a Cauchy sequence of reals, but the notion of ``Cauchy sequence of reals'' depends on having some way to measure the ``distance'' between real numbers.
In general, of course, the distance between two real numbers will be another real number, leading to a potentially problematic circularity.

However, what we actually need for the notion of Cauchy sequence (or Cauchy approximation) of reals is not the general notion of ``distance'', but a way to say that ``the distance between two real numbers is less than $\epsilon$'' for any $\epsilon:\Qp$.
This can be represented by a family of binary relations, which we will denote $\mathord{\sim_\epsilon} : \RC\to\RC\to \prop$.
The intended meaning of $x \sim_\epsilon y$ is $|x - y| < \epsilon$, but since we do not have notions of subtraction, absolute value, or inequality available yet (we are only just defining $\RC$, after all), we will have to define these relations $\sim_\epsilon$ at the same time as we define $\RC$ itself.
And since $\sim_\epsilon$ is a type family indexed by two copies of $\RC$, we cannot do this with an ordinary mutual (higher) inductive definition; instead we have to use a \emph{higher inductive-inductive definition}.

Recall from \autoref{sec:generalizations} that the ordinary notion of inductive-inductive definition allows us to define a type and a type family indexed by it by simultaneous induction.
Of course, the ``higher'' version of this allows both the type and the family to have path-constructors as well as point-constructors.
We will not attempt to formulate any general theory of higher inductive-inductive definitions, but hopefully the description we will give of $\RC$ and $\sim_\epsilon$ will make the idea transparent.

\begin{rmk}
  We might also consider a \emph{higher inductive-recursive definition}, in which $\sim_\epsilon$ is defined using the \emph{recursion} principle of $\RC$, simultaneously with the \emph{inductive} definition of $\RC$.
  We choose the inductive-inductive route instead for two reasons.
  Firstly, higher inductive-recursive definitions seem to be more difficult to justify in homotopical semantics.
  Secondly, and more importantly, the inductive-inductive definition yields a more powerful induction principle, which we will need in order to develop even the basic theory of Cauchy reals.
\end{rmk}

\begin{defn}\label{defn:cauchy-reals}
  Let $\RC$ and the relation $\mathord\sim:\Qp \times \RC \times \RC \to \type$ be the following higher inductive-inductive type family.
  The type $\RC$ of \define{Cauchy reals} is generated by the following constructors:
  \begin{itemize}
  \item \emph{rational points:} 
    for any $q : \Q$ there is a real $\rcrat(q)$.
  \item \emph{limit points}:
    for any $x : \Qp \to \RC$ such that
    %
    \begin{equation}
      \label{eq:RC-cauchy}
      \fall{\delta, \epsilon : \Qp} x_\delta \sim_{\delta + \epsilon} x_\epsilon
    \end{equation}
    %
    there is a point $\rclim(x) : \RC$. We call $x$ a \define{Cauchy approximation}.
    %
  \item \emph{paths:}
    for $u, v : \RC$ such that
    %
    \begin{equation}
      \label{eq:RC-path}
      \fall{\epsilon : \Qp} u \sim_\epsilon v
    \end{equation}
    %
    then there is a path $\rceq(u, v) : \id[\RC]{u}{v}$.
  \end{itemize}
  Simultaneously, the type family $\mathord\sim:\RC\to\RC\to\Qp \to\type$ is generated by the following constructors.
  Here $q$ and $r$ denote rational numbers; $\delta$, $\epsilon$, and $\eta$ denote positive rationals; $u$ and $v$ denote Cauchy reals; and $x$ and $y$ denote Cauchy approximations:
  \begin{itemize}
  \item if $-\epsilon < q - r < \epsilon$, then $\rcrat(q) \sim_\epsilon \rcrat(r)$,
  \item if $\rcrat(q) \sim_{\epsilon - \delta} y_\delta$, then $\rcrat(q) \sim_{\epsilon} \rclim(y)$,
  \item if $x_\delta \sim_{\epsilon - \delta} \rcrat(r)$, then $\rclim(x) \sim_\epsilon \rcrat(r)$,
  \item if $x_\delta \sim_{\epsilon - \delta - \eta} y_\eta$, then $\rclim(x) \sim_\epsilon \rclim(y)$,
  \item if $\xi,\zeta : u \sim_{\epsilon} v$ then $\xi=\zeta$ (propositional truncation).
  \end{itemize}
\end{defn}

\mentalpause

The first constructor of $\RC$ says that any rational number can be regarded as a real number.
The second says that from any Cauchy approximation to a real number, we can obtain a new real number called its ``limit''.
And the third expresses the idea that if two Cauchy approximations coincide, then their limits are equal.
(Note that the notion of ``coincidence'' is \emph{simpler} than that of \autoref{defn:cauchy-approximation}, since we are free to use the relation~$\sim$ between Cauchy reals themselves.
Moreover, it also handles equalities between limits and rational points.)

The first four constructors of $\sim$ specify when two rational numbers are close, when a rational is close to a limit, and when two limits are close.
In the case of two rational numbers, this is just the usual notion of $\epsilon$-closeness for rational numbers, whereas the other cases can be derived by noting that each approximant $x_\delta$ is supposed to be within $\delta$ of the limit $\rclim(x)$.

We remind ourselves of proof-relevance: a real number obtained from $\rclim$ is represented not
just by a Cauchy approximation $x$, but also a proof $p$ of~\eqref{eq:RC-cauchy}, so we
should technically have written $\rclim(x,p)$ instead of just $\rclim(x)$.
A similar observation also applies to $\rceq$ and~\eqref{eq:RC-path}, but we shall write just
$\rceq : u = v$ instead of $\rceq(u, v, p) : u = v$. These abuses of notation are
mitigated by the fact that we are omitting mere propositions and information that is
readily guessed.
Likewise, the last constructor of $\mathord{\sim_\epsilon}$ justifies our leaving the other four nameless.

We are immediately able to populate $\RC$ with many real numbers. For suppose $x : \N \to
\Q$ is a traditional Cauchy sequence of rational numbers, and let $M : \Qp \to \N$ be its
modulus of convergence. Then $\rcrat \circ x \circ M : \Qp \to \RC$ is a Cauchy
approximation, using the first constructor of $\sim$ to produce the necessary witness.
Thus, $\rclim(\rcrat \circ x \circ m)$ is a real number. Various famous
real numbers $\sqrt{2}$, $\pi$, $e$, \dots{} are all limits of such Cauchy sequences of
rationals.

\subsection{Induction and recursion on Cauchy reals}
\label{sec:induct-recurs-cauchy}

In order to do anything useful with $\RC$, of course, we need to give its induction principle.
As is the case whenever we inductively define two or more objects at once, the basic induction principle for $\RC$ and $\mathord\sim$ requires a simultaneous induction over both at once.
Thus, we should expect it to say that assuming two type families over $\RC$ and $\sim$, respectively, together with data corresponding to each constructor, there exist sections of both of these families.
However, since $\sim$ is indexed on two copies of $\RC$, the precise dependencies of these families is a bit subtle.
The induction principle will apply to any pair of type families:
\begin{align*}
A&:\RC\to\type\\
B&:\prd{x,y:\RC} A(x) \to A(y) \to \prd{\epsilon:\Qp} (x\sim_\epsilon y) \to \type.
\end{align*}
The type of $A$ is obvious, but the type of $B$ requires a little thought.
Since $B$ must depend on $\sim$, but $\sim$ in turn depends on two copies of $\RC$ and one copy of $\Qp$, it is fairly obvious that $B$ must also depend on the variables $x,y:\RC$ and $\epsilon:\Qp$ as well as an element of $(x\sim_\epsilon y)$.
What is slightly less obvious is that $B$ must also depend on $A(x)$ and $A(y)$.

This may be more evident if we consider the non-dependent case (the recursion principle), where $A$ is a simple type.
In this case we would expect $B$ not to depend on $x,y:\RC$ or $x\sim_\epsilon y$.
But the recursion principle (along with its associated uniqueness principle) is supposed to say that $\RC$ with $\sim_\epsilon$ is an ``initial object'' in some category, so in this case the dependency structure of $A$ and $B$ should mirror that of $\RC$ and $\sim_\epsilon$: that is, we should have $B:A\to A\to \Qp \to \type$.
Combining this observation with the fact that, in the dependent case, $B$ must also depend on $x,y:\RC$ and $x\sim_\epsilon y$, leads inevitably to the type given above for $B$.

Now, given $A$ and $B$ as above, the hypotheses of the induction principle consist of the following data, one for each constructor of $\RC$ or $\sim$:
\begin{itemize}
\item For any $q : \Q$, an element $f_q:A(\rcrat(q))$.
\item For any Cauchy approximation $x$, and any $a:\prd{\epsilon:\Qp} A(x_\epsilon)$ such that
  \begin{equation}
    \fall{\delta, \epsilon : \Qp} B(x_\delta,x_\epsilon,a_\delta,a_\epsilon,\delta+\epsilon,\blank),\label{eq:depCauchyappx}
  \end{equation}
  an element $f_{x,a}:A(\rclim(x))$.  We call such $a$ a \define{dependent Cauchy approximation} over $x$.
\item For $u, v : \RC$ and $h:\fall{\epsilon : \Qp} u \sim_\epsilon v$, and $a:A(u)$ and $b:A(v)$ such that $\fall{\epsilon:\Qp} B(u,v,a,b,\epsilon,h(\epsilon))$, a dependent path $\dpath{A}{\rceq(u,v)}{a}{b}$.
\item For $q,r:\Q$ and $\epsilon:\Qp$, if $-\epsilon < q - r < \epsilon$, an element of $B(\rcrat(q),\rcrat(r),f_q,f_r,\epsilon,\blank)$.
\item For $q:\Q$ and $\delta,\epsilon:\Qp$ and $y$ a Cauchy approximation, and $b$ a dependent Cauchy approximation over $y$, if $\rcrat(q) \sim_{\epsilon - \delta} y_\delta$, then
  \[B(\rcrat(q),y_\delta,f_q,b_\delta,\epsilon-\delta,\blank)
  \to
  B(\rcrat(q),\rclim(y),f_q,f_{y,b},\epsilon,\blank).\]
\item Similarly, for $r:\Q$ and $\delta,\epsilon:\Qp$ and $x$ a Cauchy approximation, and $a$ a dependent Cauchy approximation over $x$, if $x_\delta \sim_{\epsilon - \delta} \rcrat(r)$, then
  \[B(x_\delta,\rcrat(r),a_\delta,f_r,\epsilon-\delta,\blank) \to
  B(\rclim(y),\rcrat(q),f_{x,a},f_r,\epsilon,\blank).
  \]
\item For $\epsilon,\delta,\eta:\Qp$ and $x,y$ Cauchy approximations, and $a$ and $b$ dependent Cauchy approximations over $x$ and $y$ respectively, if $x_\delta \sim_{\epsilon - \delta - \eta} y_\eta$, then
  \[ B(x_\delta,y_\eta,a_\delta,b_\eta,{\epsilon - \delta - \eta},\blank)\to
  B(\rclim(x),\rclim(y),f_{x,a},f_{y,b},\epsilon,\blank).\]
\item For $\epsilon:\Qp$ and $x,y:\RC$ and $\xi,\zeta:x\sim_{\epsilon} y$, and $a:A(x)$ and $b:A(y)$, any two elements of $B(x,y,a,b,\epsilon,\xi)$ and $B(x,y,a,b,\epsilon,\zeta)$ are dependently equal over $\xi=\zeta$.
  Note that as usual, this is essentially equivalent to asking that $B$ is a mere relation.
\end{itemize}
Under these hypotheses, we deduce functions
\begin{align*}
  f&:\prd{x:\RC} A(x)\\
  g&:\prd{x,y:\RC}{\epsilon:\Qp}{\xi:x\sim_{\epsilon} y} B(x,y,f(x),f(y),\epsilon,\xi)
\end{align*}
which compute as expected:
\begin{align*}
  f(\rcrat(q)) &\defeq f_q\\
  f(\rclim(x)) &\defeq f_{x,(f,g)[x]}
\end{align*}
Here $(f,g)[x]$ denotes the result of applying $f$ and $g$ to a Cauchy approximation $x$ to obtain a dependent Cauchy approximation over $x$.
That is, we define $(f,g)[x]_\epsilon \defeq f(x_\epsilon) : A(x_\epsilon)$, and then for any $\epsilon,\delta:\Qp$ we have $g(x_\epsilon,x_\delta,\epsilon+\delta,\blank)$ to witness the fact that $(f,g)[x]$ is a dependent Cauchy approximation.

This induction principle is admittedly quite a mouthful.
To help make sense of it, we observe that it contains as special cases two separate induction principles for~$\RC$ and for~$\sim$.
Firstly, suppose given only a type family $A:\RC\to\type$, and define $B$ to be constant at \unit.
Then much of the required data becomes trivial, and we are left with:
\begin{itemize}
\item for any $q : \Q$, an element $f_q:A(\rcrat(q))$,
\item for any Cauchy approximation $x$, and any $a:\prd{\epsilon:\Qp} A(x_\epsilon)$, an element $f_{x,a}:A(\rclim(x))$,
\item for $u, v : \RC$ and $h:\fall{\epsilon : \Qp} u \sim_\epsilon v$, and $a:A(u)$ and $b:A(v)$, a dependent path $\dpath{A}{\rceq(u,v)}{a}{b}$.
\end{itemize}
Given these data, the induction principle yields a function $f:\prd{x:\RC} A(x)$ such that
\begin{align*}
  f(\rcrat(q)) &\defeq f_q\\
  f(\rclim(x)) &\defeq f_{x,f(x)}.
\end{align*}
We call this principle \define{$\RC$-induction}; it says essentially that if we take $\sim_\epsilon$ as given, then $\RC$ is inductively generated by its constructors.

In particular, if $A$ is a mere property, the third hypothesis in $\RC$-induction is trivial.
Thus, we may prove mere properties of real numbers by simply proving them for rationals and for limits of Cauchy approximations.
Here is an example.

\begin{lem}
  For any $u:\RC$ and $\epsilon:\Qp$, we have $u\sim_\epsilon u$.
\end{lem}
\begin{proof}
  Define $A(u) \defeq \fall{\epsilon:\Qp} (u\sim_\epsilon u)$.
  Since this is a mere proposition (by the last constructor of $\sim$), by $\RC$-induction, it suffices to prove it when $u$ is $\rcrat(q)$ and when $u$ is $\rclim(x)$.
  In the first case, we obviously have $|q-q|<\epsilon$ for any $\epsilon$, hence $\rcrat(q) \sim_\epsilon \rcrat(q)$ by the first constructor of $\sim$.
  %
  And in the second case, we may assume inductively that $x_\delta \sim_\epsilon x_\delta$ for all $\delta,\epsilon:\Qp$.
  Then in particular, we have $x_{\epsilon/3} \sim_{\epsilon/3} x_{\epsilon/3}$, whence $\rclim(x) \sim_{\epsilon} \rclim(x)$ by the fourth constructor of $\sim$.
\end{proof}

\begin{thm}\label{thm:Cauchy-reals-are-a-set}
  $\RC$ is a set.
\end{thm}
\begin{proof}
  We have just shown that the mere relation $P(u,v) \defeq \fall{\epsilon:\Qp} (u\sim_\epsilon v)$ is reflexive.
  Since it implies identity, by the path-constructor of $\RC$, the result follows from \autoref{thm:h-set-refrel-in-paths-sets}.
\end{proof}

We can also show that although $\RC$ may not be a quotient of the set of Cauchy sequences of \emph{rationals}, it is nevertheless a quotient of the set of Cauchy sequences of \emph{reals}.
(Of course, this is not a valid \emph{definition} of $\RC$, but it is a useful property.)
We define the type of Cauchy approximations to be
% 
\begin{equation*}
  \CAP \defeq
  \setof{ x : \Qp \to \RC |
    \fall{\epsilon, \delta : \Qp} x_\delta \sim_{\delta + \epsilon} x_\epsilon
  }.
\end{equation*}
The second constructor of $\RC$ gives a function $\rclim:\CAP\to\RC$.

\begin{lem} \label{RC-lim-onto}
  Every real merely is a limit point: $\fall{u : \RC} \exis{x : \CAP} u = \rclim(x)$.
  In other words, $\rclim:\CAP\to\RC$ is surjective.
\end{lem}
\begin{proof}
  By $\RC$-induction, we may divide into cases on $u$.
  Of course, if $u$ is a limit $\rclim(x)$, the statement is trivial.
  So suppose $u$ is a rational point $\rcrat(q)$; we claim $u$ is equal to $\rclim(\lam{\blank} \rcrat(q))$.
  By the path-constructor of $\RC$, it suffices to show $\rcrat(q) \sim_\epsilon \rclim(\lam{\blank} \rcrat(q))$ for all $\epsilon:\Qp$.
  And by the second constructor of $\sim$, for this it suffices to find $\delta:\Qp$ such that $\rcrat(q)\sim_{\epsilon-\delta} \rcrat(q)$.
  But by the first constructor of $\sim$, we may take any $\delta:\Qp$ with $\delta<\epsilon$.
\end{proof}

% 

\begin{lem} \label{RC-lim-factor}
  If $A$ is a set and $f : \CAP \to A$ respects coincidence of Cauchy approximations, in the sense that
  %
  \begin{equation*}
    \fall{x, y : \CAP} \rclim(x) = \rclim(y) \Rightarrow f(x) = f(y),
  \end{equation*}
  %
  then $f$ factors uniquely through $\rclim : \CAP \to \RC$.
\end{lem}
\begin{proof}
  Since $\rclim$ is surjective, by \autoref{lem:images_are_coequalizers}, $\RC$ is the quotient of $\CAP$ by the kernel of $\rclim$.
  But this is exactly the statement of the lemma.
\end{proof}

For the second special case of the induction principle, suppose instead that we are given only $C:\RC\to\RC\to\Qp\to\prop$, and define $A(\blank)\defeq\unit$ and $B(u,v,\blank,\blank,\epsilon,\blank)\defeq C(u,v,\epsilon)$.
Then the required data reduces to the following, where $q, r$ denote rational numbers, $\epsilon, \delta, \eta$ positive rational numbers, and $x, y$ Cauchy approximations:
\begin{itemize}
\item if $-\epsilon < q - r < \epsilon$, then $C(\rcrat(q),\rcrat(r),\epsilon)$,
\item if $\rcrat(q) \sim_{\epsilon - \delta} y_\delta$ and
  $C(\rcrat(q),y_\delta,\epsilon-\delta)$,
  then $C(\rcrat(q),\rclim(y),\epsilon)$,
\item similarly, if $x_\delta \sim_{\epsilon - \delta} \rcrat(r)$ and
  $C(x_\delta,\rcrat(r),\epsilon-\delta)$,
  then $C(\rclim(y),\rcrat(q),\epsilon)$,
\item if $x_\delta \sim_{\epsilon - \delta - \eta} y_\eta$ and
  $C(x_\delta,y_\eta,{\epsilon - \delta - \eta})$,
  then $C(\rclim(x),\rclim(y),\epsilon)$.
\end{itemize}
The resulting conclusion is $\fall{u,v:\RC}{\epsilon:\Qp} (u\sim_\epsilon v) \to C(u,v,\epsilon)$.
We call this principle \define{$\sim$-induction}; it says essentially that if we take $\RC$ as given, then $\sim_\epsilon$ is inductively generated (as a family of types) by \emph{its} constructors.
For example, we can use this to show that $\sim$ is symmetric.

\begin{lem}\label{thm:RCsim-symmetric}
  For any $u,v:\RC$ and $\epsilon:\Qp$, we have $(u\sim_\epsilon v) = (v\sim_\epsilon u)$.
\end{lem}
\begin{proof}
  Since both are mere propositions, by symmetry it suffices to show one implication.
  Thus, let $C(u,v,\epsilon) \defeq (v\sim_\epsilon u)$.
  By $\sim$-induction, we may reduce to the case that $u\sim_\epsilon v$ is derived from one of the four interesting constructors of $\sim$.
  In the first case when $u$ and $v$ are both rational, the result is trivial (we can apply the first constructor again).
  In the other three cases, the inductive hypothesis (together with commutativity of addition in $\Q$) yields exactly the input to another of the constructors of $\sim$ (the second and third constructors switch, while the fourth stays put).
\end{proof}

The general induction principle, which we may call \define{$(\RC,\sim)$-induction}, is therefore a sort of joint $\RC$-induction and $\sim$-induction.
Consider, for instance, its non-dependent version, which we call \define{$(\RC,\sim)$-recursion}, which is the one that we will have the most use for.
Ordinary $\RC$-recursion tells us that to define a function $f : \RC \to A$ it suffices to:
\begin{enumerate}
\item for every $q : \Q$ construct $f(\rcrat(q)) : A$,
\item for every Cauchy approximation $x : \Qp \to \RC$, construct $f(x) : A$,
  assuming that $f(x_\epsilon)$ has already been defined for all $\epsilon : \Qp$,
\item prove $f(u) = f(v)$ for all $u, v : \RC$ satisfying $\fall{\epsilon:\Qp} u\sim_\epsilon v$.\label{item:rcrec3}
\end{enumerate}
However, it is generally quite difficult to show~\ref{item:rcrec3} without knowing something about how $f$ acts on $\epsilon$-close Cauchy reals.
The enhanced principle of $(\RC,\sim)$-recursion remedies this deficiency, allowing us to specify an \emph{arbitrary} ``way in which $f$ acts on $\epsilon$-close Cauchy reals'', which we can then prove to be the case by a simultaneous induction with the definition of $f$.
This is the family of relations $B:A\to A\to \Qp\to\prop$.
If we write the mere property $B(a,b,\epsilon)$ as ``$a \bsim_\epsilon b$'', then defining a function $f:\RC\to A$ by $(\RC,\sim)$-recursion requires the following cases.
\begin{itemize}
\item For every $q : \Q$, construct $f(\rcrat(q)) : A$.
\item For every Cauchy approximation $x : \Qp \to \RC$, construct $f(x) : A$, assuming inductively that $f(x_\epsilon)$ has already been defined for all $\epsilon : \Qp$ and form a ``Cauchy approximation with respect to $\bsim$'', i.e.\ that $\fall{\epsilon,\delta:\Qp} (f(x_\epsilon) \bsim_{\epsilon+\delta} f(x_\delta))$.
\item Prove that the relations $\bsim$ are \emph{separated}, i.e.\ that $(\fall{\epsilon:\Qp} a\bsim_\epsilon b) \to (a=b)$ for any $a,b:A$.
\item Prove that if $-\epsilon< q-r <\epsilon$ for $q,r:\Q$, then $f(\rcrat(q))\bsim_\epsilon f(\rcrat(r))$.
\item For any $q:\Q$ and any Cauchy approximation $y$, prove that $f(\rcrat(q)) \bsim_\epsilon f(\rclim(y))$, assuming inductively that $\rcrat(q)\sim_{\epsilon-\delta} y_\delta$ and $f(\rcrat(q)) \bsim_{\epsilon-\delta} f(y_\delta)$ for some $\delta:\Qp$, and that $\eta \mapsto f(x_\eta)$ is a Cauchy approximation with respect to $\bsim$.
\item For any Cauchy approximation $x$ and any $r:\Q$, prove that $f(\rclim(x)) \bsim_\epsilon f(\rcrat(r))$, assuming inductively that $x_\delta \sim_{\epsilon-\delta} \rcrat(r)$ and $f(x_\delta) \bsim_{\epsilon-\delta} f(\rcrat(r))$ for some $\delta:\Qp$, and that $\eta\mapsto f(x_\eta)$ is a Cauchy approximation with respect to $\bsim$.
\item For any Cauchy approximations $x,y$, prove that $f(\rclim(x)) \bsim_\epsilon f(\rclim(y))$, assuming inductively that $x_\delta \sim_{\epsilon-\delta-\eta} y_\eta$ and $f(x_\delta) \bsim_{\epsilon-\delta-\eta} f(y_\eta)$ for some $\delta,\eta:\Qp$, and that $\theta\mapsto f(x_\theta)$ and $\theta\mapsto f(y_\theta)$ are Cauchy approximations with respect to $\bsim$.
\end{itemize}
Note that in the last four proofs, we are free to use the specific definitions of $f(\rcrat(q))$ and $f(\rclim(x))$ given in the first two data.
However, the proof of separatedness must apply to \emph{any} two elements of $A$, without any relation to $f$: it is a sort of ``admissibility'' condition on the family of relations $\bsim$.
Thus, we often verify it first, immediately after defining $\bsim$, before going on to define $f(\rcrat(q))$ and $f(\rclim(x))$.

Under the above hypotheses, $(\RC,\sim)$-recursion yields a function $f:\RC\to A$ such that $f(\rcrat(q))$ and $f(\rclim(x))$ are judgmentally equal to the definitions given for them in the first two clauses.
Moreover, we may also conclude
\begin{equation}
  \fall{u,v:\RC}{\epsilon:\Qp} (u\sim_\epsilon v) \to (f(u) \bsim_\epsilon f(v)).\label{eq:RC-sim-recursion-extra}
\end{equation}

As a paradigmatic example, $(\RC,\sim)$-recursion allows us to extend functions defined on $\Q$ to all of $\RC$, as long as they are sufficiently continuous.

\begin{defn}\label{defn:lipschitz}
  A function $f:\Q\to\RC$ is \define{Lipschitz} if there exists $L:\Qp$ (the \define{Lipschitz constant}) such that
  \[ |q - r|<\epsilon \Rightarrow (f(q) \sim_{L\epsilon} f(r)) \]
  for all $\epsilon:\Qp$ and $q,r:\Q$.
  %
  Similarly, $g:\RC\to\RC$ is \define{Lipschitz} if there exists $L:\Qp$ such that
  \[ (u\sim_\epsilon v) \Rightarrow (g(u) \sim_{L\epsilon} g(v)) \]
  for all $\epsilon:\Qp$ and $u,v:\RC$..
\end{defn}

In particular, note that by the first constructor of $\sim$, if $f:\Q\to\Q$ is Lipschitz in the obvious sense, then so is the composite $\Q\xrightarrow{f} \Q \hookrightarrow \RC$.

\begin{lem}\label{RC-extend-Q-Lipschitz}
  Suppose $f : \Q \to \RC$ is Lipschitz with constant $L : \Qp$.
  Then there exists a Lipschitz map $\bar{f} : \RC \to \RC$, also with constant $L$, such that $\bar{f}(\rcrat(q)) \jdeq f(q)$ for all $q:\Q$.
\end{lem}

\begin{proof}
  % Uniqueness follows directly from \autoref{RC-continuous-eq}.
  We define $\bar{f}$ by $(\RC,\sim)$-recursion, with codomain $A\defeq \RC$.
  We define the relation $\mathord{\bsim}: \RC \to \RC \to \Qp \to \prop$ to be
  \begin{align*}
    (u \bsim_\epsilon v) &\defeq (u \sim_{L\epsilon} v).
  \end{align*}
  For $q : \Q$, we define
  %
  \begin{equation*}
    \bar{f}(\rcrat(q)) \defeq \rcrat(f(q)).
  \end{equation*}
  %
  For a Cauchy approximation $x : \Qp \to \RC$, we define
  % 
  \begin{equation*}
    \bar{f}(\rclim(x)) \defeq \rclim(\lamu{\epsilon : \Qp} \bar{f}(x_{\epsilon/L})).
  \end{equation*}
  %
  For this to make sense, we must verify that $y \defeq \lamu{\epsilon : \Qp} \bar{f}(x_{\epsilon/L})$ is a Cauchy approximation.
  However, the inductive hypothesis for this step is that for any $\delta,\epsilon:\Qp$ we have $\bar{f}(x_\delta) \bsim_{\delta+\epsilon} \bar{f}(x_\epsilon)$, i.e.\ $\bar{f}(x_\delta) \sim_{L\delta+L\epsilon} \bar{f}(x_\epsilon)$.
  Thus we have
  \[y_\delta \jdeq f(x_{\delta/L}) \sim_{\delta + \epsilon} f(x_{\epsilon/L})   \jdeq y_\epsilon. \]
  
  For the proof of separatedness, we simply observe that $\fall{\epsilon:\Qp} a\bsim_\epsilon b$ means $\fall{\epsilon:\Qp} a\sim_{L\epsilon} b$, which implies $\fall{\epsilon:\Qp}a\sim_\epsilon b$ and thus $a=b$.

  To complete the $(\RC,\sim)$-recursion, it remains to verify the four conditions on $\bsim$.
  This basically amounts to proving that $\bar f$ is Lipschitz for all the four constructors of $\sim$.
  \begin{enumerate}
  \item When $u$ is $\rcrat(q)$ and $v$ is $\rcrat(r)$ with $-\epsilon < |q-r| <\epsilon$, the assumption that $f$ is Lipschitz yields $f(q) \sim_{L\epsilon} f(r)$, hence $\bar{f}(\rcrat(q)) \bsim_\epsilon \bar{f}(\rcrat(r))$ by definition.
  \item When $u$ is $\rclim(x)$ and $v$ is $\rcrat(q)$ with $x_\eta \sim_{\epsilon - \eta} \rcrat(q)$, then the
      induction hypothesis is $\bar{f}(x_\eta) \sim_{L \epsilon - L \eta} \rcrat(f(q))$, which proves $\bar{f}(\rclim(x)) \sim_{L \epsilon}
      \bar{f}(\rcrat(q))$ by the third constructor of $\sim$.
  \item The symmetric case when $u$ is rational and $v$ is a limit is essentially identical.
  \item When $u$ is $\rclim(x)$ and $v$ is $\rclim(y)$, with $\delta, \eta : \Qp$ such that $x_\delta \sim_{\epsilon - \delta - \eta} y_\eta$,
      the induction hypothesis is $\bar{f}(x_\delta) \sim_{L \epsilon - L \delta - L \eta} \bar{f}(y_\eta)$, which proves $\bar{f}(\rclim(x)) \sim_{L
        \epsilon} \bar{f}(\rclim(y))$ by the fourth constructor of $\sim$.
  \end{enumerate}
  This completes the $(\RC,\sim)$-recursion, and hence the construction of $\bar f$.
  The desired equality $\bar f(\rcrat(q))\jdeq f(q)$ is exactly the first computation rule for $(\RC,\sim)$-recursion, and the additional condition~\eqref{eq:RC-sim-recursion-extra} says exactly that $\bar f$ is Lipschitz with constant $L$.
\end{proof}

At this point we have gone about as far as we can without a better characterization of $\sim$.
We have specified, in the constructors of $\sim$, the conditions under which we want Cauchy reals of the two different forms to be $\epsilon$-close.
However, how do we know that in the resulting inductive-inductive type family, these are the \emph{only} witnesses to this fact?
We have seen that inductive type families (such as identity types, see \autoref{sec:identity-systems}) and higher inductive types have a tendency to contain ``more than was put into them'', so this is not an idle question.

In order to characterize $\sim$ more precisely, we will define a family of relations $\approx_\epsilon$ on $\RC$ \emph{recursively}, so that they will compute on constructors, and prove that this family is equivalent to $\sim_\epsilon$.

% More specifically, we will define $\mathord\approx:\RC\to\RC\to\Qp\to\prop$, together with some of its basic properties, by double $(\RC,\sim)$-recursion.
% Roughly, the $\RC$-part of the definition will be the family of relations $\approx_\epsilon$, together with the fact that they are \emph{rounded}.
% The $\sim$-part of the definition will be that these relations satisfy the ``triangle inequality'' with respect to $\sim_\epsilon$.
% These two facts will be what enable us to show that $\approx_\epsilon$ respects the path constructor of $\RC$, allowing the recursion to go through.

\begin{thm}\label{defn:RC-approx}
  There is a family of mere relations $\mathord\approx:\RC\to\RC\to\Qp\to\prop$ such that
  \begin{align}
    (\rcrat(q) \approx_\epsilon \rcrat(r))  &\defeq
    (-\epsilon < q - r < \epsilon)\label{eq:RCappx1}\\
    (\rcrat(q) \approx_\epsilon \rclim(y)) &\defeq
    \exis{\delta : \Qp} \rcrat(q) \approx_{\epsilon - \delta} y_\delta\label{eq:RCappx2}\\
    (\rclim(x) \approx_\epsilon \rcrat(r)) &\defeq
    \exis{\delta : \Qp} x_\delta \approx_{\epsilon - \delta} \rcrat(r)\label{eq:RCappx3}\\
    (\rclim(x) \approx_\epsilon \rclim(y)) &\defeq
    \exis{\delta, \eta : \Qp} x_\delta \approx_{\epsilon - \delta - \eta} y_\eta.\label{eq:RCappx4}
  \end{align}
  Moreover, we have
  \begin{gather}
    (u \approx_\epsilon v) \leftrightarrow \exis{\theta:\Qp} (u \approx_{\epsilon-\theta} v) \label{RC-sim-rounded}\\
    (u \approx_\epsilon v) \to (v\sim_\delta w) \to (u\approx_{\epsilon+\delta} w)\label{eq:RC-sim-rtri}\\ 
    (u \sim_\epsilon v) \to (v\approx_\delta w) \to (u\approx_{\epsilon+\delta} w)\label{eq:RC-sim-ltri}.
  \end{gather}
\end{thm}

The additional conditions~\eqref{RC-sim-rounded}--\eqref{eq:RC-sim-ltri} turn out to be required in order to make the inductive definition go through.
Condition~\eqref{RC-sim-rounded} is called being \define{rounded}.
Reading it from right to left gives \define{monotonicity} of $\approx$,
%
\begin{equation*}
  (\delta < \epsilon) \land (u \approx_\delta v) \Rightarrow (u \approx_\epsilon v)
\end{equation*}
%
while reading it left to right to \define{openness} of $\approx$,
%
\begin{equation*}
  (u \approx_\epsilon v) \Rightarrow \exis{\epsilon : \Qp} (\delta < \epsilon) \land (u \approx_\delta v).
\end{equation*}
%
Conditions~\eqref{eq:RC-sim-rtri} and~\eqref{eq:RC-sim-ltri} are forms of the triangle inequality, which say that $\approx$ is a ``module'' over $\sim$ on both sides.

\begin{proof}
  We will define $\mathord\approx:\RC\to\RC\to\Qp\to\prop$ by double $(\RC,\sim)$-recursion.
  First we will apply $(\RC,\sim)$-recursion with codomain the subset of $\RC\to\Qp\to\prop$ consisting of those families of predicates which are rounded and satisfy the one appropriate form of the triangle inequality.
  Thinking of these predicates as half of a binary relation, we will write them as $(u,\epsilon) \mapsto (\hapx_\epsilon u)$, with the symbol $\hapname$ referring to the whole relation.
  Now we can write $A$ precisely as
  \begin{multline*}
    A \defeq\; \Bigg\{ \hapname :\RC\to\Qp\to\prop \;\bigg|\; \\
    \Big(\fall{u:\RC}{\epsilon:\Qp}
    \big((\hapx_\epsilon u) \leftrightarrow \exis{\theta:\Qp} (\hapx_{\epsilon-\theta} u)\big)\Big)  \\
    \land \Big(\fall{u,v:\RC}{\eta,\epsilon:\Qp} (u\sim_\epsilon v) \to\\
    \big((\hapx_\eta u) \to (\hapx_{\eta+\epsilon} v) \big) \land \big((\hapx_\eta v) \to (\hapx_{\eta+\epsilon} u) \big)\Big)\Bigg\}
  \end{multline*}
  As usual with subsets, we will use the same notation for an inhabitant of $A$ and its first component $\hapname$.
  As the family of relations required for $(\RC,\sim)$-recursion, we consider the following, which will ensure the other form of the triangle inequality:
  \begin{equation*}
    (\hapname \bsim_\epsilon \hapbname )
    \defeq \fall{u:\RC}{\eta:\Qp} ((\hapx_\eta u) \to (\hapxb_{\epsilon+\eta} u)) \land ((\hapxb_\eta u) \to (\hapx_{\epsilon+\eta} u)).
  \end{equation*}
  We observe that these relations are separated.
  For assuming $\fall{\epsilon:\Qp} (\hapname \bsim_\epsilon \hapbname)$, to show $\hapname = \hapbname$ it suffices to show $(\hapx_\epsilon u) \leftrightarrow (\hapxb_\epsilon u)$ for all $u:\RC$.
  But $\hapx_\epsilon u$ implies $\hapx_{\epsilon-\theta} u$ for some $\theta$, by roundedness, which together with $\hapname \bsim_\epsilon \hapbname$ implies $\hapxb_\epsilon u$; and the converse is identical.

  Now the first two data the recursion principle requires are the following.
  \begin{itemize}
  \item For any $q:\Q$, we must give an element of $A$, which we denote $(\rcrat(q)\approx_{(-)} -)$.
  \item For any Cauchy approximation $x$, if we assume defined a function $\Qp \to A$, which we will denote by $\epsilon \mapsto (x_\epsilon \approx_{(-)} -)$, with the property that 
    % \[ \fall{u,v:\RC}{\delta,\epsilon,\eta:\Qp} (x_\delta \approx_\eta u) \to (u\sim_{\delta+\epsilon} v) \to (x_\epsilon \approx_{\eta+\delta+\epsilon} v) \]
    \begin{equation}
      \fall{u:\RC}{\delta,\epsilon,\eta:\Qp} (x_\delta \approx_\eta u) \to (x_\epsilon \approx_{\eta+\delta+\epsilon} u),\label{eq:appxrec2}
    \end{equation}
    we must give an element of $A$, which we will denote $(\rclim(x)\approx_{(-)} -)$.
  \end{itemize}
  In both cases, we give the required definition by using a nested $(\RC,\sim)$-recursion, with codomain the subset of $\Qp\to\prop$ consisting of rounded families of mere propositions.
  Thinking of these propositions as zero halves of a binary relation, we will write them as $\epsilon \mapsto (\tap{\epsilon})$, with the symbol $\tapname$ referring to the whole family.
  Now we can write the codomain of these inner recursions precisely as
  \begin{equation*}
    C \defeq \bigg\{ \tapname :\Qp\to\prop \;\;\Big|\;\;
    \fall{\epsilon:\Qp} \Big((\tap\epsilon) \leftrightarrow \exis{\theta:\Qp} (\tap{\epsilon-\theta})\Big)\bigg\}
  \end{equation*}
  We take the required family of relations to be the remnant of the triangle inequality:
  \begin{equation*}
    (\tapname \bbsim_\epsilon \tapbname) \defeq
    \fall{\eta:\Qp} ((\tap\eta) \to (\tapb{\epsilon+\eta})) \land ((\tapb\eta) \to (\tap{\epsilon+\eta})).
  \end{equation*}
  These relations are separated by the same argument as for $\bsim$, using roundedness of all elements of $C$.

  Note that if such an inner recursion succeeds, it will yield a family of predicates $\hapname : \RC\to\Qp\to \prop$ which are rounded
(since their image in $\Qp\to\prop$ lies in $C$) and satisfy
  \[ \fall{u,v:\RC}{\epsilon:\Qp} (u\sim_\epsilon v) \to \big((\hapx_{(-)} u) \bbsim_\epsilon (\hapx_{(-)} u)\big). \]
  Expanding out the definition of $\bbsim$, this yields precisely the third condition for $\hapname$ to belong to $A$; thus it is exactly what we need.

  It is at this point that we can give the definitions~\eqref{eq:RCappx1}--\eqref{eq:RCappx4}, as the first two clauses of each of the two inner recursions, corresponding to rational points and limits.
  In each case, we must verify that the relation is rounded and hence lies in $C$.
  In the rational-rational case~\eqref{eq:RCappx1} this is clear, while in the other cases it follows from an inductive hypothesis.
  (In~\eqref{eq:RCappx2} the relevant inductive hypothesis is that $(\rcrat(q) \approx_{(-)} y_\delta) : C$, while in~\eqref{eq:RCappx3} and~\eqref{eq:RCappx4} it is that $(x_\delta \approx_{(-)} -) : A$.)

  The remaining data of the sub-recursions consist of showing that~\eqref{eq:RCappx1}--\eqref{eq:RCappx4} satisfy the triangle inequality on the right with respect to the constructors of $\sim$.
  There are eight cases --- four in each sub-recursion --- corresponding to the eight possible ways that $u$, $v$, and $w$ in~\eqref{eq:RC-sim-rtri} can be chosen to be rational points or limits.
  First we consider the cases when $u$ is $\rcrat(q)$.
  \begin{enumerate}
  \item Assuming $\rcrat(q)\approx_\phi \rcrat(r)$ and $-\epsilon<|r-s|<\epsilon$, we must show $\rcrat(q)\approx_{\phi+\epsilon} \rcrat(s)$.
    But by definition of $\approx$, this reduces to the triangle inequality for rational numbers.
  \item We assume $\phi,\epsilon,\delta:\Qp$ such that $\rcrat(q)\approx_\phi \rcrat(r)$ and $\rcrat(r) \sim_{\epsilon-\delta} y_\delta$, and inductively that
    \begin{equation}
      \fall{\psi:\Qp}(\rcrat(q) \approx_{\psi} \rcrat(r)) \to (\rcrat(q) \approx_{\psi+\epsilon-\delta} y_\delta).\label{eq:RCappx-rtri-rrl1}
    \end{equation}
    We assume also that $\psi,\delta\mapsto (\rcrat(q) \approx_{\psi} y_\delta)$ is a Cauchy approximation with respect to $\bbsim$, i.e.\
    \begin{equation}
      \fall{\psi,\xi,\zeta:\Qp} (\rcrat(q) \approx_{\psi} y_\xi) \to (\rcrat(q) \approx_{\psi+\xi+\zeta} y_\zeta),\label{eq:RCappx-rtri-rrl2}
    \end{equation}
    although we will not need this assumption in this case.
    Indeed,~\eqref{eq:RCappx-rtri-rrl1} with $\psi\defeq \phi$ yields immediately $\rcrat(q) \approx_{\phi+\epsilon-\delta} y_\delta$, and hence $\rcrat(q) \approx_{\phi+\epsilon} \rclim(y)$ by definition of $\approx$.
  \item We assume $\phi,\epsilon,\delta:\Qp$ such that $\rcrat(q)\approx_\phi \rclim(y)$ and $y_\delta \sim_{\epsilon-\delta} \rcrat(r)$, and inductively that
    \begin{gather}
      \fall{\psi:\Qp}(\rcrat(q) \approx_{\psi} y_\delta) \to (\rcrat(q) \approx_{\psi+\epsilon-\delta} \rcrat(r)).\label{eq:RCappx-rtri-rlr1}\\
      \fall{\psi,\xi,\zeta:\Qp} (\rcrat(q) \approx_{\psi} y_\xi) \to (\rcrat(q) \approx_{\psi+\xi+\zeta} y_\zeta).\label{eq:RCappx-rtri-rlr2}
    \end{gather}
    Now by definition, $\rcrat(q)\approx_\phi \rclim(y)$ means we have $\theta:\Qp$ with $\rcrat(q) \approx_{\phi-\theta} y_\theta$.
    By assumption~\eqref{eq:RCappx-rtri-rlr2}, therefore, we have also $\rcrat(q) \approx_{\phi+\delta} y_\delta$.
    But now by assumption~\eqref{eq:RCappx-rtri-rlr1}, we have $\rcrat(q) \approx_{\phi+\epsilon} \rcrat(r)$, as desired.
  \item We assume $\phi,\epsilon,\delta,\eta:\Qp$ such that $\rcrat(q)\approx_\phi \rclim(y)$ and $y_\delta \sim_{\epsilon-\delta-\eta} z_\eta$, and inductively that 
    \begin{gather}
      \fall{\psi:\Qp}(\rcrat(q) \approx_{\psi} y_\delta) \to (\rcrat(q) \approx_{\psi+\epsilon-\delta-\eta} z_\eta)\label{eq:RCappx-rtri-rll1}\\
      \fall{\psi,\xi,\zeta:\Qp} (\rcrat(q) \approx_{\psi} y_\xi) \to (\rcrat(q) \approx_{\psi+\xi+\zeta} y_\zeta)\label{eq:RCappx-rtri-rll2}\\
      \fall{\psi,\xi,\zeta:\Qp} (\rcrat(q) \approx_{\psi} z_\xi) \to (\rcrat(q) \approx_{\psi+\xi+\zeta} z_\zeta)\label{eq:RCappx-rtri-rll3}
    \end{gather}
    Again, $\rcrat(q)\approx_\phi \rclim(y)$ means we have $\xi:\Qp$ with $\rcrat(q) \approx_{\phi-\xi} y_\xi$, while~\eqref{eq:RCappx-rtri-rll2} then implies $\rcrat(q) \approx_{\phi+\delta} y_\delta$ and~\eqref{eq:RCappx-rtri-rll1} implies $\rcrat(q) \approx_{\phi+\epsilon-\eta} z_\eta$.
    But by definition of $\approx$, this implies $\rcrat(q) \approx_{\phi+\epsilon} \rclim(z)$ as desired.
  \end{enumerate}
  Now we move on to the cases when $u$ is $\rclim(x)$, with $x$ a Cauchy approximation.
  In this case, the ambient induction hypothesis of the definition of $(\rclim(x) \approx_{(-)} -) : A$ is that we have $(x_\delta \approx_{(-)} -): A$, so that in addition to being rounded they satisfy the triangle inequality on the right.
  \begin{enumerate}\setcounter{enumi}{4}
  \item Assuming $\rclim(x)\approx_\phi \rcrat(r)$ and $-\epsilon<|r-s|<\epsilon$, we must show $\rclim(x)\approx_{\phi+\epsilon} \rcrat(s)$.
    But by definition of $\approx$, the former means $x_\delta \approx_{\phi-\delta} \rcrat(r)$, so that above-mentioned triangle inequality implies $x_\delta \approx_{\epsilon+\phi-\delta} \rcrat(s)$, hence $\rclim(x)\approx_{\phi+\epsilon} \rcrat(s)$ as desired.
  \item We assume $\phi,\epsilon,\delta:\Qp$ such that $\rclim(x)\approx_\phi \rcrat(r)$ and $\rcrat(r) \sim_{\epsilon-\delta} y_\delta$, and two unneeded inductive hypotheses.
    % \begin{gather}
    %   \fall{\psi:\Qp}(\rclim(x) \approx_{\psi} \rcrat(r)) \to (\rclim(x) \approx_{\psi+\epsilon-\delta-\theta} y_\delta)\label{eq:RCappx-rtri-lrl1}\\
    %   \fall{\psi,\xi,\zeta:\Qp} (\rclim(x) \approx_{\psi} y_\xi) \to (\rclim(x) \approx_{\psi+\xi+\zeta} y_\zeta).\label{eq:RCappx-rtri-lrl2}
    % \end{gather}
    By definition, we have $\eta:\Qp$ such that $x_\eta \approx_{\phi-\eta} \rcrat(r)$, so the inductive triangle inequality gives $x_\eta \approx_{\phi+\epsilon-\eta-\delta} y_\delta$.
    The definition of $\approx$ then immediately yields $\rclim(x) \approx_{\phi+\epsilon} \rclim(y)$.
  \item We assume $\phi,\epsilon,\delta:\Qp$ such that $\rclim(x)\approx_\phi \rclim(y)$ and $y_\delta \sim_{\epsilon-\delta} \rcrat(r)$, and two unneeded inductive hypotheses.
    % \begin{gather}
    %   \fall{\psi:\Qp}(\rclim(x) \approx_{\psi} \rcrat(r)) \to (\rclim(x) \approx_{\psi+\epsilon-\delta-\theta} y_\delta)\label{eq:RCappx-rtri-llr1}\\
    %   \fall{\psi,\xi,\zeta:\Qp} (\rclim(x) \approx_{\psi} y_\xi) \to (\rclim(x) \approx_{\psi+\xi+\zeta} y_\zeta).\label{eq:RCappx-rtri-llr2}
    % \end{gather}
    By definition, then, we have $\xi,\theta:\Qp$ such that $x_\xi \approx_{\phi-\xi-\theta} y_\theta$.
    Since $y$ is a Cauchy approximation, we have $y_\theta \sim_{\theta+\delta} y_\delta$, so the inductive triangle inequality gives $x_\xi \approx_{\phi+\delta-\xi} y_\delta$ and then $x_\xi \sim_{\phi+\epsilon-\xi} \rcrat(r)$.
    The definition of $\approx$ then gives $\rclim(x) \approx_{\phi+\epsilon}\rcrat(r)$, as desired.
  \item Finally, we assume $\phi,\epsilon,\delta,\eta:\Qp$ such that $\rclim(x)\approx_\phi \rclim(y)$ and $y_\delta \sim_{\epsilon-\delta-\eta} z_\eta$.
    Then as before we have $\xi,\theta:\Qp$ with $x_\xi \approx_{\phi-\xi-\theta} y_\theta$, and two applications of the triangle inequality suffices as before.
  \end{enumerate}

  This completes the two inner recursions, and thus the definitions of the families of relations $(\rcrat(q)\approx_{(-)}-)$ and $(\rclim(x)\approx_{(-)}-)$.
  Since all are elements of $A$, they are rounded and satisfy the triangle inequality on the right with respect to $\sim$.
% , and satisfy~\eqref{eq:appxrec2}.
  What remains is to verify the conditions relating to $\bsim$, which is to say that these relations satisfy the triangle inequality on the \emph{left} with respect to the constructors of $\sim$.
  The four cases correspond to the four choices of rational or limit points for $u$ and $v$ in~\eqref{eq:RC-sim-ltri}, and since they are all mere propositions, we may apply $\RC$-induction and assume that $w$ is also either rational or a limit.
  This yields another eight cases, whose proofs are essentially identical to those just given; so we will not subject the reader to them.
\end{proof}

We can now prove:

\begin{thm}\label{thm:RC-sim-characterization}
  For any $u,v:\RC$ and $\epsilon:\Qp$ we have $(u\sim_\epsilon v) = (u\approx_\epsilon v)$.
\end{thm}
\begin{proof}
  Since both are mere propositions, it suffices to prove bidirectional implication.
  For the left-to-right direction, we use $\sim$-induction with $C(u,v,\epsilon)\defeq (u\approx_\epsilon v)$.
  Thus, it suffices to consider the four constructors of $\sim$.
  In each case, $u$ and $v$ are specialized to either rational points or limits, so that the definition of $\approx$ evaluates, and the inductive hypothesis always applies.

  For the right-to-left direction, we use $\RC$-induction to assume that $u$ and $v$ are rational points or limits, allowing $\approx$ to evaluate.
  But now the definitions of $\approx$, and the inductive hypotheses, supply exactly the data required for the relevant constructors of $\sim$.
\end{proof}

Stretching a point, one might call $\approx$ a fibration of ``codes'' for $\sim$, with the two directions of the above proof being \encode and \decode respectively.
By the definition of $\approx$, from \autoref{thm:RC-sim-characterization} we get equivalences
\begin{align*}
  (\rcrat(q) \sim_\epsilon \rcrat(r))  &=
  (-\epsilon < q - r < \epsilon)\\
  (\rcrat(q) \sim_\epsilon \rclim(y)) &=
  \exis{\delta : \Qp} \rcrat(q) \sim_{\epsilon - \delta} y_\delta\\
  (\rclim(x) \sim_\epsilon \rcrat(r)) &=
  \exis{\delta : \Qp} x_\delta \sim_{\epsilon - \delta} \rcrat(r)\\
  (\rclim(x) \sim_\epsilon \rclim(y)) &=
  \exis{\delta, \eta : \Qp} x_\delta \sim_{\epsilon - \delta - \eta} y_\eta.
\end{align*}
Our proof also provides the following additional information.

\begin{cor}
  $\sim$ is rounded and satisfies the triangle inequality:
    \begin{gather}
      \eqvspaced{
        (u \sim_\epsilon v)
      }{
        \exis{\theta : \Qp} u \sim_{\epsilon - \theta} v
      }\\
      (u\sim_\epsilon v) \to (v\sim_\delta w) \to (u\sim_{\epsilon+\delta} w)\label{item:RC-sim-triangle}
    \end{gather}
\end{cor}
% \begin{proof}
%   The construction of $\approx$ showed simultaneously that it is rounded, and satisfies ``triangle inequalities'' such as
%   \[ (u\approx_\epsilon v) \to (v\sim_\delta w) \to (u\approx_{\epsilon+\delta} w). \]
%   Thus, both properties follow from \autoref{thm:RC-sim-characterization}.
% \end{proof}

With the triangle inequality in hand, we can show that ``limits'' of Cauchy approximations actually behave like limits.

\begin{lem}\label{thm:RC-sim-lim}
  For any $u:\RC$, Cauchy approximation $y$, and $\epsilon,\delta:\Qp$, if $u\sim_\epsilon y_\delta$ then $u\sim_{\epsilon+\delta} \rclim(y)$.
\end{lem}
\begin{proof}
  We use $\RC$-induction on $u$.
  If $u$ is $\rcrat(q)$, then this is exactly the second constructor of $\sim$.
  Now suppose $u$ is $\rclim(x)$, and that each $x_\eta$ has the property that for any $y,\epsilon,\delta$, if $x_\eta\sim_\epsilon y_\delta$ then $x_\eta \sim_{\epsilon+\delta} \rclim(y)$.
  In particular, taking $y\defeq x$ and $\delta\defeq\eta$ in this assumption, we conclude that $x_\eta \sim_{\eta+\theta} \rclim(x)$ for any $\eta,\theta:\Qp$.

  Now let $y,\epsilon,\delta$ be arbitrary and assume $\rclim(x) \sim_\epsilon y_\delta$.
  By roundedness, there is a $\theta$ such that $\rclim(x) \sim_{\epsilon-\theta} y_\delta$.
  Then by the above observation, for any $\eta$ we have $x_\eta \sim_{\eta+\theta/2} \rclim(x)$, and hence $x_\eta \sim_{\epsilon+\eta-\theta/2} y_\delta$ by the triangle inequality.
  Hence, the fourth constructor of $\sim$ yields $\rclim(x) \sim_{\epsilon+2\eta+\delta-\theta/2} \rclim(y)$.
  Thus, if we choose $\eta \defeq \theta/4$, the result follows.
\end{proof}

\begin{lem}\label{thm:RC-sim-lim-term}
  For any Cauchy approximation $y$ and any $\delta,\eta:\Qp$ we have $y_\delta \sim_{\delta+\eta} \rclim(y)$.
\end{lem}
\begin{proof}
  Take $u\defeq y_\delta$ and $\epsilon\defeq \eta$ in the previous lemma.
\end{proof}

\begin{rmk}
  We might have expected to have $y_\delta \sim_{\delta} \rclim(y)$, but this fails in examples.
  For instance, consider $x$ defined by $x_\epsilon \defeq \epsilon$.
  Its limit is clearly $0$, but we do not have $|\epsilon - 0 |<\epsilon$, only $\le$.
\end{rmk}

As an application, \autoref{thm:RC-sim-lim-term} enables us to show that the extensions of Lipschitz functions from \autoref{RC-extend-Q-Lipschitz} are unique.

\begin{lem}\label{RC-continuous-eq}
  Let $f,g:\RC\to\RC$ be continuous, in the sense that
  \[ \fall{u:\RC}{\epsilon:\Qp}\exis{\delta:\Qp}\fall{v:\RC} (u\sim_\delta v) \to (f(u) \sim_\epsilon f(v)) \]
  and analogously for $g$.
  If $f(\rcrat(q))=g(\rcrat(q))$ for all $q:\Q$, then $f=g$.
\end{lem}
\begin{proof}
  We prove $f(u)=g(u)$ for all $u$ by $\RC$-induction.
  The rational case is just the hypothesis.
  Thus, suppose $f(x_\delta)=g(x_\delta)$ for all $\delta$.
  We will show that $f(\rclim(x))\sim_\epsilon g(\rclim(x))$ for all $\epsilon$, so that the path-constructor of $\RC$ applies.

  Since $f$ and $g$ are continuous, there exist $\theta,\eta$ such that for all $v$, we have
  \begin{align*}
    (\rclim(x)\sim_\theta v) &\to (f(\rclim(x)) \sim_{\epsilon/2} f(v))\\
    (\rclim(x)\sim_\eta v) &\to (g(\rclim(x)) \sim_{\epsilon/2} g(v)).
  \end{align*}
  Choosing $\delta < \min(\theta,\eta)$, by \autoref{thm:RC-sim-lim-term} we have both $\rclim(x)\sim_\theta y_\delta$ and $\rclim(x)\sim_\eta y_\delta$.
  Hence
  \[ f(\rclim(x)) \sim_{\epsilon/2} f(y_\delta) = g(y_\delta) \sim_{\epsilon/2} g(\rclim(x))\]
  and thus $f(\rclim(x))\sim_\epsilon g(\rclim(x))$ by the triangle inequality.
\end{proof}

\subsection{The algebraic structure of Cauchy reals}
\label{sec:algebr-struct-cauchy}

We first define the additive structure $(\RC, 0, {+}, {-})$. Clearly, the neutral element
$0$ is just $\rcrat(0)$, while the additive inverse ${-} : \RC \to \RC$ is obtained as the
extension of the additive inverse ${-} : \Q \to \Q$, using \autoref{RC-extend-Q-Lipschitz}
with Lipschitz factor~$1$. We have to work a bit harder for addition.

\begin{lem} \label{RC-binary-nonexpanding-extension}
  Suppose $f : \Q \times \Q \to \Q$ satisfies, for all $q, r, s : \Q$,
  %
  \begin{equation*}
    |f(q, s) - f(r, s)| \leq |q - r|
    \qquad\text{and}\qquad
    |f(q, r) - f(q, s)| \leq |r - s|.
  \end{equation*}
  %
  Then there is a function $\bar{f} : \RC \times \RC \to \RC$ such that
  $\bar{f}(\rcrat(q), \rcrat(r)) = f(q,r)$ for all $q, r : \Q$. Furthermore,
  for all $u, v, w : \RC$ and $q : \Qp$,
  %
  \begin{equation*}
    u \sim_\epsilon v \Rightarrow \bar{f}(u,w) \sim_\epsilon \bar{f}(v,w)
    \quad\text{and}\quad
    v \sim_\epsilon w \Rightarrow \bar{f}(u,v) \sim_\epsilon \bar{f}(u,w).
  \end{equation*}
\end{lem}

\begin{proof}
  We use $(\RC, {\sim})$-recursion to construct the curried form of $\bar{f}$ as a map
  $\RC \to A$ where $A$ is the space of non-expanding real-valued
  functions:
  % 
  \begin{equation*}
    A \defeq
    \setof{ h : \RC \to \RC |
      \fall{\epsilon : \Qp} \fall{u, v : \RC}
      u \sim_\epsilon v \Rightarrow h(u) \sim_\epsilon h(v)
    }.
  \end{equation*}
  %
  We shall also need a suitable $\bsim_\epsilon$ on $A$, which we define as
  %
  \begin{equation*}
    (h \bsim_\epsilon k) \defeq \fall{u : \RC} h(u) \sim_\epsilon k(u).
  \end{equation*}
  %
  Clearly, if $\fall{\epsilon : \Qp} h \bsim_\epsilon k$ then $h(u) = k(u)$ for all $u :
  \RC$, so $\bsim$ is separated.

  For the base case we define $\bar{f}(\rcrat(q)) : A$, where $q : \Q$, as the
  extension of the Lipschitz map $\lam{r} f(q,r)$ from $\Q \to \Q$ to $\RC \to \RC$, as
  constructed in \autoref{RC-extend-Q-Lipschitz} with Lipschitz constant~$1$. Next, for a
  Cauchy approximation $x$, we define $\bar{f}(\rclim(x)) : \RC \to \RC$ as
  %
  \begin{equation*}
    \bar{f}(\rclim(x))(v) \defeq \rclim (\lam{\epsilon} \bar{f}(x_\epsilon)(v)).
  \end{equation*}
  %
  For this to be a valid definition, $\lam{\epsilon} \bar{f}(x_\epsilon)(v)$ should be a
  Cauchy approximation, so consider any $\delta, \epsilon : \Q$. Then by assumption
  $\bar{f}(x_\delta) \bsim_{\delta + \epsilon} \bar{f}(x_\epsilon)$, hence
  $\bar{f}(x_\delta)(v) \sim_{\delta + \epsilon} \bar{f}(x_\epsilon)(v)$. Furthermore,
  $\bar{f}(\rclim(x))$ is non-expanding because $\bar{f}(x_\epsilon)$ is such by induction
  hypothesis. Indeed, if $u \sim_\epsilon v$ then, for all $\epsilon : \Q$,
  %
  \begin{equation*}
    \bar{f}(x_{\epsilon/3})(u) \sim_{\epsilon/3} \bar{f}(x_{\epsilon/3})(v),
  \end{equation*}
  %
  therefore $\bar{f}(\rclim(x))(u) \sim_\epsilon \bar{f}(\rclim(x))(v)$.

  We still have to check four more conditions, let us illustrate just one. Suppose
  $\epsilon : \Qp$ and for some $\delta : \Qp$ we have $\rcrat(q) \sim_{\epsilon - \delta}
  y_\delta$ and $\bar{f}(\rcrat(q)) \bsim_{\epsilon - \delta} \bar{f}(y_\delta)$. To show
  $\bar{f}(\rcrat(q)) \bsim_\epsilon \bar{f}(y)$, consider any $v : \RC$ and observe that
  %
  \begin{equation*}
    \bar{f}(q)(v) \sim_{\epsilon - \delta} \bar{f}(y_\delta)(v)
  \end{equation*}
  %
  and because $y_\delta \sim y$ also
  %
  \begin{equation*}
    \bar{f}(y_\delta)(v) \sim_\delta \bar{f}(y)(v),
  \end{equation*}
  %
  therefore $\bar{f}(q)(v) \sim_\epsilon \bar{f}(y)(v)$, as required.
\end{proof}

We may apply \autoref{RC-binary-nonexpanding-extension} to any bivariate rational function
which is non-expanding separately in each variable. Addition is such a function, therefore
we get ${+} : \RC \times \RC \to \RC$. Furthermore, the extension is unique as long as we
require it to be non-expanding in each variable, and just as in the univariate case,
identities on rationals extend to identities on reals. Since composition of non-expanding
maps is again non-expanding, we may conclude that addition satisfies the usual properties,
such as commutativity and associativity. Therefore, $(\RC, 0, {+}, {-})$ is a commutative
group.

We may also apply \autoref{RC-binary-nonexpanding-extension} to the functions $\min : \Q \times
\Q \to \Q$ and $\max : \Q \times \Q \to \Q$, which turns $\RC$ into a lattice. The partial
order $\leq$ on $\RC$ is defined in terms of $\max$ as
%
\begin{equation*}
  (u \leq v) \defeq (\max(u, v) = v).
\end{equation*}
%
The relation $\leq$ is a partial order because it is such on $\Q$, and the axioms of
partial order are expressible as equations in terms of $\min$ and $\max$, so they transfer
to $\RC$.

Another function which extends to $\RC$ by the same method is the absolute value $|{-}|$.
Again, it has the expected properties because they transfer from $\Q$ to $\RC$.

From $\leq$ we get the strict order $<$ by
%
\begin{equation*}
  (u < v) \defeq \exis{q, r : \Qp} (u \leq q) \land (q < r) \land (r \leq v).
\end{equation*}
%
That is, $u < v$ holds when there merely exists a pair of rational numbers $q < r$ such that $x \leq
\rcrat(q)$ and $\rcrat(r) \leq v$. It is not hard to check that $<$ is irreflexive and
transitive, and has other properties that are expected for an ordered field.
The archimedean principle follows directly from the definition of~$<$.

\begin{thm}[Archimedean principle for $\RC$] \label{RC-archimedean}
  %
  For every $u, v : \RC$ such that $u < v$ there merely exists $q : \Q$ such that $u < q < v$.
\end{thm}

\begin{proof}
  From $u < v$ we merely get $r, s : \Q$ such that $u < r < s < v$, and we may take $q
  \defeq (r + s) / 2$.
\end{proof}

We now have enough structure on $\RC$ to express $u \sim_\epsilon v$ with standard concepts.

\begin{lem}\label{thm:RC-le-grow}
  If $q:\Q$ and $u:\RC$ satisfy $u\le \rcrat(q)$, then for any $v:\RC$ and $\epsilon:\Qp$, if $u\sim_\epsilon v$ then $v\le \rcrat(q+\epsilon)$.
\end{lem}
\begin{proof}
  Note that the function $\max(\rcrat(q),-):\RC\to\RC$ is Lipschitz with constant $1$.
  First consider the case when $u=\rcrat(r)$ is rational.
  For this we use induction on $v$.
  If $v$ is rational, then the statement is obvious.
  If $v$ is $\rclim(y)$, we assume inductively that for any $\epsilon,\delta$, if $\rcrat(r)\sim_\epsilon y_\delta$ then $y_\delta \le \rcrat(q+\epsilon)$, i.e.\ $\max(\rcrat(q+\epsilon),y_\delta)=\rcrat(q+\epsilon)$.

  Now assuming $\epsilon$ and $\rcrat(r)\sim_\epsilon \rclim(y)$, we have $\theta$ such that $\rcrat(r)\sim_{\epsilon-\theta} \rclim(y)$, hence $\rcrat(r)\sim_\epsilon y_\delta$ whenever $\delta<\theta$.
  Thus, the inductive hypothesis gives $\max(\rcrat(q+\epsilon),y_\delta)=\rcrat(q+\epsilon)$ for such $\delta$.
  But by definition,
  \[\max(\rcrat(q+\epsilon),\rclim(y)) \jdeq \rclim(\lam{\delta} \max(\rcrat(q+\epsilon),y_\delta)).\]
  Since the limit of an eventually constant Cauchy approximation is that constant, we have 
  \[\max(\rcrat(q+\epsilon),\rclim(y)) = \rcrat(q+\epsilon),\] hence $\rclim(y)\le \rcrat(q+\epsilon)$.
  
  Now consider a general $u:\RC$.
  Since $u\le \rcrat(q)$ means $\max(\rcrat(q),u)=\rcrat(q)$, the assumption $u\sim_\epsilon v$ and the Lipschitz property of $\max(\rcrat(q),-)$ imply $\max(\rcrat(q),v) \sim_\epsilon \rcrat(q)$.
  Thus, since $\rcrat(q)\le \rcrat(q)$, the first case implies $\max(\rcrat(q),v) \le \rcrat(q+\epsilon)$, and hence $v\le \rcrat(q+\epsilon)$ by transitivity of $\le$.
\end{proof}

\begin{lem}\label{thm:RC-lt-open}
  Suppose $q:\Q$ and $u:\RC$ satisfy $u<\rcrat(q)$.  Then:
  \begin{enumerate}
  \item For any $v:\RC$ and $\epsilon:\Qp$, if $u\sim_\epsilon v$ then $v< \rcrat(q+\epsilon)$.\label{item:RCltopen1}
  \item There exists $\epsilon:\Qp$ such that for any $v:\RC$, if $u\sim_\epsilon v$ we have $v<\rcrat(q)$.\label{item:RCltopen2}
  \end{enumerate}
\end{lem}
\begin{proof}
  By definition, $u<\rcrat(q)$ means there is $r:\Q$ with $r<q$ and $u\le \rcrat(r)$.
  Then by \autoref{thm:RC-le-grow}, for any $\epsilon$, if $u\sim_\epsilon v$ then $v\le \rcrat(r+\epsilon)$.
  Conclusion~\ref{item:RCltopen1} follows immediately since $r+\epsilon<q+\epsilon$, while for~\ref{item:RCltopen2} we can take any $\epsilon <q-r$.
\end{proof}

We are now able to show that the auxiliary relation $\sim$ is what we think it is.

\begin{thm} \label{RC-sim-eqv-le}
  $\eqv{(u \sim_\epsilon v)}{(|u - v| < \rcrat(\epsilon))}$
  for all $u, v : \RC$ and $\epsilon : \Qp$.
\end{thm}
\begin{proof}
  The Lipschitz properties of subtraction and absolute value imply that if $u\sim_\epsilon v$, then $|u-v| \sim_\epsilon |u-u| = 0$.
  Thus, for the left-to-right direction, it will suffice to show that if $u\sim_\epsilon 0$, then $|u|<\rcrat(\epsilon)$.
  We proceed by $\RC$-induction on $u$.

  If $u$ is rational, the statement follows immediately since absolute value and order extend the standard ones on $\Qp$.
  If $u$ is $\rclim(x)$, then by roundedness we have $\theta:\Qp$ with $\rclim(x)\sim_{\epsilon-\theta} 0$.
  By the triangle inequality, therefore, we have $x_{\theta/3} \sim_{\epsilon-2\theta/3} 0$, so the inductive hypothesis yields $|x_{\theta/3}|<\rcrat(\epsilon-2\theta/3)$.
  But $x_{\theta/3} \sim_{2\theta/3} \rclim(x)$, hence $|x_{\theta/3}| \sim_{2\theta/3} |\rclim(x)|$ by the Lipschitz property, so \autoref{thm:RC-lt-open}\ref{item:RCltopen1} implies $|\rclim(x)|<\rcrat(\epsilon)$.

  In the other direction, we use $\RC$-induction on $u$ and $v$.
  If both are rational, this is the first constructor of $\sim$.

  If $u$ is $\rcrat(q)$ and $v$ is $\rclim(y)$, we assume inductively that for any $\epsilon,\delta$, if $|\rcrat(q)-y_\delta|<\rcrat(\epsilon)$ then $\rcrat(q) \sim_{\epsilon} y_\delta$.
  Fix an $\epsilon$ such that $|\rcrat(q) - \rclim(y)|<\rcrat(\epsilon)$.
  Since $\Q$ is order-dense in $\RC$, there exists $\theta<\epsilon$ with $|\rcrat(q) - \rclim(y)|<\rcrat(\theta)$.
  Now for any $\delta,\eta$ we have $\rclim(y)\sim_{2\delta} y_\delta$, hence by the Lipschitz property
  \[ |\rcrat(q) - \rclim(y)| \sim_{\delta+\eta} |\rcrat(q) - y_\delta|. \]
  Thus, by \autoref{thm:RC-lt-open}\ref{item:RCltopen1}, we have $|\rcrat(q) - y_\delta| < \rcrat(\theta+2\delta)$.
  So by the inductive hypothesis, $\rcrat(q) \sim_{\theta+2\delta} y_\delta$, and thus $\rcrat(q)\sim_{\theta+4\delta} \rclim(y)$ by the triangle inequality.
  Thus, it suffices to choose $\delta \defeq (\epsilon-\theta)/4$.

  The remaining two cases are entirely analogous.
\end{proof}

Next, we would like to equip $\RC$ with multiplicative structure. For each $q : \Q$ the
map $r \mapsto q \cdot r$ is Lipschitz with constant\footnote{We defined Lipschitz
  constants as \emph{positive} rational numbers.} $|q| + 1$, and so we can extend it to
multiplication by $q$ on the real numbers. Therefore $\RC$ is a vector space over $\Q$.
In general, we can define multiplication of real numbers as
%
\begin{equation*}
  u \cdot v \defeq
  {\textstyle \frac{1}{2}} \cdot ((u + v)^2 - u^2 - v^2),
\end{equation*}
%
so we just need squaring $u \mapsto u^2$ as a map $\RC \to \RC$. Squaring is not a
Lipschitz map, but it is Lipschitz on every bounded domain, which allows us to patch it
together. Define the open and closed intervals
%
\begin{equation*}
  [u,v] \defeq \setof{ x : \RC | u \leq x \leq v }
  \qquad\text{and}\qquad
  (u,v) \defeq \setof{ x : \RC | u < x < v }.
\end{equation*}

\begin{thm} \label{RC-squaring}
  %
  There exists a unique function ${(-)}^2 : \RC \to \RC$ which extends squaring $q \mapsto
  q^2$ of rational numbers and satisfies
  %
  \begin{equation*}
    \fall{n : \N}
    \fall{u, v : [-n, n]}
    |u^2 - v^2| \leq 2 \cdot n \cdot |u - v|.
  \end{equation*}
\end{thm}

\begin{proof}
  We first observe that for every $u : \RC$ there merely exists $n : \N$ such that $-n
  \leq u \leq n$, see \autoref{ex:traditional-archimedean}, so the map
  %
  \begin{equation*}
    e : \left(\sm{n : \N} [-n, n]\right) \to \RC
    \qquad\text{defined by}\qquad
    e(n, \pairr{x, \blank}) \defeq x
  \end{equation*}
  % 
  is surjective. Next, for each $n : \N$, the squaring map
  %
  \begin{equation*}
    s_n : \setof{ q : \Q | -n \leq q \leq n } \to \Q
    \qquad\text{defined by}\qquad
    s_n(q, \blank) \defeq q^2
  \end{equation*}
  %
  is Lipschitz with constant $2 n$, so we can use \autoref{RC-extend-Q-Lipschitz} to
  extend it to a map $\bar{s}_n : [-n, n] \to \RC$ with Lipschitz constant $2 n$, see
  \autoref{RC-Lipschitz-on-interval} for details. The maps $\bar{s}_n$ are compatible: if
  $m < n$ for some $m, n : \N$ then $s_n$ restricted to $[-m, m]$ must agree with $s_m$
  because both are Lipschitz, and therefore continuous in the sense
  of~\autoref{RC-continuous-eq}. Therefore, by \autoref{lem:images_are_coequalizers} the map
  %
  \begin{equation*}
    \left(\sm{n : \N} [-n, n]\right) \to \RC,
    \qquad\text{given by}\qquad
    (n, \pairr{x, \blank}) \mapsto s_n(x)
  \end{equation*}
  %
  factors uniquely through $\RC$ to give us the desired function.
\end{proof}

At this point we have the ring structure of the reals and the archimedean order. To
establish $\RC$ as an archimedean ordered field, we still need inverses.

\begin{thm}
  A Cauchy real is invertible if, and only if, it is apart from zero.
\end{thm}

\begin{proof}
  First, suppose $u : \RC$ has an inverse $v : \RC$ By the archimedean principle there is $q :
  \Q$ such that $|v| < q$. Then $1 = |u v| < |u| \cdot v < |u| \cdot q$ and hence $|u| >
  1/q$, which is to say that $u \apart 0$.

  For the converse we construct the inverse map
  %
  \begin{equation*}
    ({-})^{-1} : \setof{ u : \RC | u \apart 0 } \to \RC
  \end{equation*}
  % 
  by patching together functions, similarly to the construction of squaring in
  \autoref{RC-squaring}. We only outline the main steps. For every $q : \Q$ let
  %
  \begin{equation*}
    [q, \infty) \defeq \setof{u : \RC | q \leq u}
    \qquad\text{and}\qquad
    (-\infty, q] \defeq \setof{u : \RC | u \leq -q}.
  \end{equation*}
  %
  Then, as $q$ ranges over $\Qp$, the types $(-\infty, q]$ and $[q, \infty)$ jointly cover
  $\setof{u : \RC | u \apart 0}$. On each such $[q, \infty)$ and $[-\infty, q)$ the
  inverse function is obtained by an application of \autoref{RC-extend-Q-Lipschitz}
  with Lipschitz constant $1/q^2$. Finally, \autoref{lem:images_are_coequalizers}
  guarantees that the inverse function factors uniquely through $\setof{ u : \RC | u
    \apart 0 }$.
\end{proof}

We summarize the algebraic structure of $\RC$ with a theorem.

\begin{thm} \label{RC-archimedean-ordered-field}
  The Cauchy reals form an archimedean ordered field.
\end{thm}

\subsection{Cauchy reals are Cauchy complete}
\label{sec:cauchy-reals-cauchy-complete}

We constructed $\RC$ by closing $\Q$ under limits of Cauchy approximations, so it better
be the case that $\RC$ is Cauchy complete. Thanks to \autoref{RC-sim-eqv-le} there is no
difference between a Cauchy approximation $x : \Qp \to \RC$ as defined in the construction
of $\RC$, and a Cauchy approximation in the sense of \autoref{defn:cauchy-approximation}
(adapted to $\RC$).

Thus, given a Cauchy approximation $x : \Qp \to \RC$ is is quite natural to expect that
$\rclim(x)$ is its limit, where the notion of limit is defined as in
\autoref{defn:cauchy-approximation}. But this is so by \autoref{RC-sim-eqv-le} and
\autoref{thm:RC-sim-lim-term}. We have proved:

\begin{thm}
  Every Cauchy approximation in $\RC$ has a limit.
\end{thm}

An archimedean ordered field in which every Cauchy approximation has a limit is called
\define{Cauchy complete}. The Cauchy reals are the least such field.

\begin{thm} \label{RC-initial-Cauchy-complete}
  The Cauchy reals embed into every Cauchy complete archimedean ordered field.
\end{thm}

\begin{proof}
  Suppose $F$ is a Cauchy complete archimedean ordered field. Because limits are unique,
  there is an operator $\lim$ which takes Cauchy approximations in $F$ to their limits. We
  define the embedding $e : \RC \to F$ by $(\RC, {\sim})$-recursion as
  %
  \begin{equation*}
    e(\rcrat(q)) \defeq q
    \qquad\text{and}\qquad
    e(\rclim(x)) \defeq \lim (e \circ x).
  \end{equation*}
  %
  A suitable $\bsim$ on $F$ is
  %
  \begin{equation*}
    (a \bsim_\epsilon b) \defeq |a - b| < \epsilon.
  \end{equation*}
  %
  This is a separated relation because $F$ is archimedean. The rest of the clauses for
  $(\RC, {\sim})$-recursion are easily checked. One would also have to check that $e$ is
  an embedding of ordered fields which fixes the rationals.
\end{proof}


\section{Comparison of Cauchy and Dedekind reals}
\label{sec:comp-cauchy-dedek}

Let us also say something about the relationship between the Cauchy and Dedekind reals. By
\autoref{RC-archimedean-ordered-field}, $\RC$ is an archimedean ordered field. It is also
admissible for $\Omega$, as can be easily checked. (In case $\Omega$ is the initial
$\sigma$-frame it takes a simple induction, while in other cases it is immediate.)
Therefore, by \autoref{RD-final-field} there is an embedding of ordered fields
%
\begin{equation*}
  \RC \to \RD
\end{equation*}
%
which fixes the rational numbers. In general we do not expect $\RC$ and $\RD$ to coincide
without further assumptions. 

\begin{lem} \label{lem:untruncated-linearity-reals-coincide}
  %
  If for every $x : \RD$ there merely exists
  %
  \begin{equation}
    \label{eq:untruncated-linearity}
    c : \prd{x : \RD} \prd{q, r : \Q} (q < r) \to (q < x) + (x < r)
  \end{equation}
  %
  then the Cauchy and Dedekind reals coincide.
\end{lem}

\begin{proof}
  Note that the type in~\eqref{eq:untruncated-linearity} is an untruncated variant
  of~\eqref{eq:RD-linear-order}, which states that~$<$ is an intuitionistic linear order.
  We already know that $\RC$ embeds into $\RD$, so it suffices to show that every Dedekind
  real merely is the limit of a Cauchy sequence of rational numbers.

  Consider any $x : \RD$. By assumption there merely exists $c$ as in the statement of the
  lemma, and by boundedness of cuts there merely exist $a, b : \Q$ such that $a < x < b$.
  We construct a sequence $f : \N \to \setof{ \pairr{q, r} \in \Q \times \Q | q < r }$ by
  recursion:
  %
  \begin{enumerate}
  \item Set $f(0) \defeq \pairr{a, b}$.
  \item Suppose $f(n)$ is already defined as $\pairr{q_n, r_n}$ such that $q_n < r_n$.
    Define $s \defeq (2 q_n + r_n)/3$ and $t \defeq (q_n + 2 r_n)/3$. Then $c(x,s,t)$
    decides between $s < x$ and $x < t$. If it decides $s < x$ then we set $f(n+1) \defeq
    \pairr{s, r_n}$, otherwise $f(n+1) \defeq \pairr{q_n, t}$.
  \end{enumerate}
  %
  Let us write $\pairr{q_n, r_n}$ for the $n$-th term of the sequence~$f$. Then it is easy
  to see that $q_n < x < r_n$ and $|q_n - r_n| \leq (2/3)^n \cdot |q_0 - r_0|$ for all $n
  : \N$. Therefore $q_0, q_1, \ldots$ and $r_0, r_1, \ldots$ are both Cauchy sequences
  converging to the Dedekind cut~$x$. We have shown that for every $x : \RD$ there merely
  exists a Cauchy sequence converging to $x$.
\end{proof}

The lemma implies that either Countable Choice or excluded middle suffice for coincidence
of $\RC$ and $\RD$.

\begin{cor} \label{when-reals-coincide}
  If excluded middle or Countable Choice holds then $\RC$ and $\RD$ are equivalent.
\end{cor}

\begin{proof}
  If excluded middle holds then $(x < y) \to (x < z) + (z < y)$ can be proved: either $x <
  z$ or $\lnot (x < z)$. In the former case we are done, while in the latter we get $z <
  y$ because $z \leq x < y$. Therefore, we get~\eqref{eq:untruncated-linearity} so that we
  can apply \autoref{lem:untruncated-linearity-reals-coincide}.

  Suppose Countable Choice holds. The set $S = \setof{ \pairr{q, r} \in \Q \times \Q | q <
    r }$ is equivalent to $\N$, so we may apply Countable Choice to the statement that $x$
  is located,
  %
  \begin{equation*}
    \fall{\pairr{q, r} : S} (q < x) \lor (x < r).
  \end{equation*}
  %
  Note that $(q < x) \lor (x < r)$ is expressible as an existential statement $\exis{b :
    \bool} (b = \bfalse \to q < x) \land (b = \btrue \to x < r)$. The (curried form) of
  the choice function is then precisely~\eqref{eq:untruncated-linearity} so that
  \autoref{lem:untruncated-linearity-reals-coincide} is applicable again.
\end{proof}

\section{Compactness of the interval}
\label{sec:compactness-interval}

We already pointed out that our constructions of reals are entirely compatible with
classical logic. Thus, by assuming the law of excluded middle~\eqref{eq:lem} and the axiom
of choice~\eqref{eq:ac} we could develop classical analysis, which would essentially
amount to copying any standard book on analysis.

Nevertheless, anyone interested in computation, for example a numerical analyst, ought to
be curious about developing analysis in a computationally meaningful setting. That
analysis in a constructive setting is even possible was demonstrated by~\cite{Bishop1967}.
As a sample of the differences and similarities between classical and constructive
analysis we shall briefly discuss just one topic---compactness of the closed interval
$[0,1]$ and a couple of theorems surrounding the concept.

Compactness is no exception to the common phenomenon in constructive mathematics that
classically equivalent notions bifurcate. The three most frequently used notions of
compactness are:
%
\begin{enumerate}
\item \define{metric compact:} ``Cauchy complete and totally bounded'',
\item \define{Bolzano-Weierstraß compact:} ``every sequence has a convergent subsequence'',
\item \define{Heine-Borel compact:} ``every open cover has a finite subcover''.
\end{enumerate}
%
These are all equivalent in classical mathematics.
Let us see how they fare in homotopy type theory. We can use either the Dedekind or the
Cauchy reals, so we shall denote the reals just as~$\R$. We first recall several basic
definitions.

\begin{defn} \label{defn:metric-space}
  A \define{metric space $(M, d)$} is a set $M$ with a map $d : M \times M \to \R$
  satisfying, for all $x, y, z : M$,
  %
  \begin{align*}
    d(x,y) &\geq 0, &
    d(x,y) &= d(y,x), \\
    d(x,y) &= 0 \Leftrightarrow x = y, &
    d(x,z) &\leq d(x,y) + d(y,z).
  \end{align*}
  %
\end{defn}

\begin{defn} \label{defn:complete-metric-space}
  A \define{Cauchy approximation} in $M$ is a sequence $x : \Qp \to M$ satisfying
  %
  \begin{equation*}
    \fall{\delta, \epsilon} d(x_\delta, x_\epsilon) < \delta + \epsilon.
  \end{equation*}
  %
  The \define{limit} of a Cauchy approximation $x : \Qp \to M$ is a point $\ell : M$
  satisfying
  %
  \begin{equation*}
    \fall{\epsilon, \theta : \Qp} d(x_\epsilon, \ell) < \epsilon + \theta.
  \end{equation*}
  %
  A \define{complete metric space} is one in which every Cauchy sequence has a limit.
\end{defn}

\begin{defn} \label{defn:totall-bounded-metric-space}
  For a positive rational $\epsilon$, an \define{$\epsilon$-net} in a metric space $(M,
  d)$ is an element of
  %
  \begin{equation*}
    \sm{n : \N}{x_1, \ldots, x_n : M}
    \fall{y : M} \exis{k \leq n} d(x_k, y) < \epsilon.
  \end{equation*}
  %
  In words, this is a finite sequence of points $x_1, \ldots, x_n$ such that every point
  in $M$ merely is within $\epsilon$ of some~$x_k$.

  A metric space $(M, d)$ is \define{totally bounded} when it has $\epsilon$-nets of all
  sizes:
  %
  \begin{equation*}
    \prd{\epsilon : \Qp} 
    \sm{n : \N}{x_1, \ldots, x_n : M}
    \fall{y : M} \exis{k \leq n} d(x_k, y) < \epsilon.
  \end{equation*}
\end{defn}

\begin{rmk}
  In the definition of total boundedness we wrote $\sm{n : \N}{x_1, \ldots, x_n : M}$,
  which is sloppy notation. Formally, we should have written $\sm{x : \lst{M}}$ instead,
  where $\lst{M}$ is the inductive type of finite lists from \autoref{sec:bool-nat}.
  However, that would make the rest of the statement a bit more cumbersome to express.
\end{rmk}

Note that in the definition of total boundedness we require pure existence of an
$\epsilon$-net, not mere existence. This way we obtain a function which assigns to each
$\epsilon : \Qp$ a specific $\epsilon$-net. Such a function might be called a ``modulus of
total boundedness''. In general, when porting classical metric notions to homotopy type
theory, we should use propositional truncation sparingly, typically so that we avoid
asking for a non-constant map from $\R$ to $\Q$ or $\N$. For instance, here is the
``correct'' definition of uniform continuity.

\begin{defn} \label{defn:uniformly-continuous}
  A map $f : M \to \R$ on a metric space is \define{uniformly continuous} when
  %
  \begin{equation*}
    \prd{\epsilon : \Qp}
    \sm{\delta : \Qp}
    \fall{x, y : M}
    d(x,y) < \delta \Rightarrow |f(x) - f(y)| < \epsilon.
  \end{equation*}
  %
  In particular, a uniformly continuous map has a modulus of uniform continuity,
  which is a function that assigns to each $\epsilon$ a corresponding $\delta$.
\end{defn}

Let us show that $[0,1]$ is compact in the first sense.

\begin{thm} \label{analysis-interval-ctb}
  The closed interval $[0,1]$ is complete and totally bounded.
\end{thm}

\begin{proof}
  Given $\epsilon : \Qp$, there is $n : \N$ such that $2/k < \epsilon$, so we may take the
  $\epsilon$-net $x_i = i/k$ for $i = 0, \ldots, k-1$. This is an $\epsilon$-net because,
  for every $y : [0,1]$ there merely exists $i$ such that $0 \leq i < k$ and $(i -
  1)/k < y < (i+1)/k$, and so $|y - x_i| < 2/k < \epsilon$.

  For completeness of $[0,1]$, consider a Cauchy approximation $x : \Qp \to
  [0,1]$ and let $\ell$ be its limit in $\R$. Since $\max$ and $\min$ are Lipschitz maps,
  the retraction $r : \R \to [0,1]$ defined by $r(x) \defeq \max(0, \min(1, x))$ commutes
  with limits of Cauchy approximations, therefore
  %
  \begin{equation*}
    r(\ell) =
    r (\lim x) =
    \lim (r \circ x) =
    r (\lim x) =
    \ell,
  \end{equation*}
  %
  which means that $0 \leq \ell \leq 1$, as required.
\end{proof}

We thus have at least one good notion of compactness in homotopy type theory.
Unfortunately, it is limited to metric spaces because total boundedness is a metric
notion. We shall consider the other two notions shortly, but first we prove that a
uniformly continuous map on a totally bounded space has a supremum.

\begin{thm} \label{ctb-uniformly-continuous-sup}
  %
  A uniformly continuous map $f : M \to \R$ on a totally bounded metric space
  $(M, d)$ has a supremum $m : \R$. For every $\epsilon : \Qp$ there exists $u : M$ such
  that $|m - f(u)| < \epsilon$.
\end{thm}

\begin{proof}
  Let $h : \Qp \to \Qp$ be the modulus of uniform continuity of~$f$.
  We define a sequence $x : \Qp \to \R$ as follows: for any $\epsilon : \Q$ total
  boundedness of $M$ gives a $h(\epsilon)$-net $y_0, \ldots, y_n$. Define
  %
  \begin{equation*}
    x_\epsilon \defeq \max (f(y_0), \ldots, f(y_n)).
  \end{equation*}
  %
  We claim that $x$ is a Cauchy approximation. Consider any $\epsilon, \eta : \Q$, so that
  %
  \begin{equation*}
    x_\epsilon \jdeq \max (f(y_0), \ldots, f(y_n))
    \quad\text{and}\quad
    x_\eta \jdeq \max (f(z_0), \ldots, f(z_m))
  \end{equation*}
  %
  for some $h(\epsilon)$-net $y_0, \ldots, y_n$ and $h(\eta)$-net $z_0, \ldots, z_m$.
  Every $z_i$ is merely $h(\epsilon)$-close to some $y_j$, therefore $|f(z_i) - f(y_j)| <
  \epsilon$, from which we may conclude that
  %
  \begin{equation*}
    f(z_i) < \epsilon + f(y_j) \leq \epsilon + x_\epsilon,
  \end{equation*}
  %
  therefore $x_\eta < \epsilon + x_\epsilon$. Symmetrically we obtain $x_\eta < \eta +
  x_\eta$, therefore $|x_\eta - x_\epsilon| < \eta + \epsilon$.

  We claim that $m \defeq \lim x$ is the supremum of~$f$. To prove that $f(x) \leq m$ for
  all $x : M$ it suffices to show $\lnot (m < f(x))$. So suppose to the contrary that $m <
  f(x)$. There is $\epsilon : \Qp$ such that $m + \epsilon < f(x)$. But now merely for
  some $y_i$ participating in the definition of $x_\epsilon$ we get $|f(x) - f(y_i) <
  \epsilon$, therefore $m < f(x) - \epsilon < f(y_i) \leq m$, a contradiction.

  We finish the proof by showing that $m$ satisfies the second part of the theorem, because
  it is then automatically a least upper bound. Given any $\epsilon : \Qp$, on one hand
  $|m - fx_{\epsilon/2}| < 3 \epsilon/4$, and on the other $|f(x_{\epsilon/2}) - f(y_i)| <
  \epsilon/4$ merely for some $y_i$ participating in the definition of $x_{\epsilon/2}$,
  therefore by taking $u \defeq y_i$ we obtain $|m - f(u)| < \epsilon$ by triangle
  inequality.
\end{proof}

Now, if in \autoref{ctb-uniformly-continuous-sup} we also knew that $M$ were complete, we
could hope to weaken the assumption of uniform continuity to continuity, and strengthen
the conclusion to existence of a point at which the supremum is attained. The usual proofs
of these improvements rely on the the facts that in a complete totally bounded space
%
\begin{enumerate}
\item continuity implies uniform continuity, and
\item every sequence has a convergent subsequence.
\end{enumerate}
%
The first statement follows easily from Heine-Borel compactness, and the second is just
Bolzano-Weierstraß compactness. Unfortunately, these are both somewhat problematic. Let
us first show that Bolzano-Weirstraß compactness implies an instance of excluded middle
known as the \define{Limited Principle of Omniscience (LPO)}: every $\alpha : \N \to
\bool$,
% 
\begin{equation} \label{eq:lpo}
  \left(\sm{n : \N} \alpha(n) = \btrue\right) +
  \left(\prd{n : \N} \alpha(n) = \bfalse\right).
\end{equation}
%
Computationally speaking, we would not expect LPO to hold because it asks us to decide
whether infinitely many values of a function are~$\bfalse$.
  
\begin{thm} \label{analysis-bw-lpo}
  %
  Bolzano-Weirstraß compactness of $[0,1]$ implies the Limited Principle of Omniscience.
\end{thm}

\begin{proof}
  Given any $\alpha : \N \to \bool$, define the sequence $x : \N \to [0,1]$ by
  %
  \begin{equation*}
    x_n \defeq
    \begin{cases}
      0 & \text{if $\alpha(k) = \bfalse$ for all $k < n$,}\\
      1 & \text{if $\alpha(k) = \btrue$ for some $k < n$}.
    \end{cases}
  \end{equation*}
  %
  If the Bolzano-Weirstraß property holds, there exists a strictly increasing $f : \N \to
  \N$ such that $x \circ f$ is a Cauchy sequence. For a sufficiently large $n :
  \N$ the $n$-th term $x_{f(n)}$ is within $1/6$ of its limit. Either $x_{f(n)} < 2/3$ or
  $x_{f(n)} > 1/3$. If $x_{f(n)} < 2/3$ then~$x_n$ converges to $0$ and so $\prd{n : \N}
  \alpha(n) = \bfalse$. If $x_{f(n)} > 1/3$ then $x_{f(n)} = 1$, therefore $\sm{n : \N}
  \alpha(n) = \btrue$.
\end{proof}

While we might not mourn Bolzano-Weierstraß compactness too much, it seems harder to live
without Heine-Borel compactness, as attested by the fact that both classical mathematics
and Brouwer's Intuitionism accepted it. As we do not want to wade too deeply into general
topology, we shall work with basic open sets. In the case of $\R$ these are the open
intervals with rational endpoints. A family of such intervals, indexed by a type~$I$,
would be a map
%
\begin{equation*}
  I \to \sm{q, r : \Q} (q < r) \to \setof{ x : \R | q < x < r},
\end{equation*}
%
but since the pair $(q, r)$ already determines the open interval $\setof{ x : \R | q < x <
  r}$, and no harm is done if we throw in empty intervals, we might as well take a
\define{family of basic intervals} to be a map
%
\begin{equation*}
  \mathcal{F} : I \to \Q \times \Q.
\end{equation*}
%
To be quite precise, a family is a dependent pair $(I, \mathcal{F})$, not just
$\mathcal{F}$. A \define{finite family of basic intervals} is one indexed by $\setof{ m :
  \N | m < n}$ for some $n : \N$. We usually presented it by a finite list $[(q_0, r_0), \ldots,
(q_{n-1}, r_{n-1})]$. Finally, a \define{finite subfamily} of $(I, \mathcal{F})$ is given
by a list of indices $[i_1, \ldots, i_n]$ which then determine the finite family
$[\mathcal{F}(i_1), \ldots, \mathcal{F}(i_n)]$.

As long as we are aware of the distinction between a pair $(q, r)$ and the corresponding
interval $\setof{ x : \R | q < x < r}$, we may safely use the same notation $(q, r)$ for
both. Intersections and inclusions of intervals are expressible in terms of their
endpoints:
%
\begin{align*}
  (q, r) \cap (s, t) &\ \defeq\  (\max(q, s), \min(r, t)),\\
  (q, r) \subseteq (s, t) &\ \defeq\ (q < r \Rightarrow s \leq q < r \leq t).
\end{align*}
%
We say that $\intfam{i}{I}{(q_i, r_i)}$ \define{(pointwise) covers $[a,b]$} when
%
\begin{equation} \label{eq:cover-pointwise-truncated}
  \fall{x : [a,b]} \exis{i : I} q_i < x < r_i.
\end{equation}
%
The \define{Heine-Borel compactness for $[0,1]$} states that every covering family of $[0,1]$
merely has a finite subfamily which still covers $[0,1]$.

\begin{thm} \label{classical-Heine-Borel}
  If excluded middle holds then $[0,1]$ is Heine-Borel compact.
\end{thm}

\begin{proof}
  Assume for the purpose of reaching a contradiction that a family $\intfam{i}{I}{(a_i,
    b_i)}$ covers $[0,1]$ but no finite subfamily does. We construct a sequence of closed
  intervals $[q_n, r_n]$ which are nested, their sizes shrink to~$0$, and none of them is covered
  by a finite subfamily of $\intfam{i}{I}{(a_i, b_i)}$.

  We set $[q_0, r_0] \defeq [0,1]$. Assuming $[q_n, r_n]$ has been constructed, let $s
  \defeq (2 q_n + r_n)/3$ and $t \defeq (q_n + 2 r_n)/3$. Both $[q_n, t]$ and $[s, r_n]$
  are covered by $\intfam{i}{I}{(a_i, b_i)}$, but they cannot both have a finite subcover,
  or else so would $[q_n, r_n]$. Either $[q_n, t]$ has a finite subcover or it does not.
  If it does we set $[q_{n+1}, r_{n+1}] \defeq [s, r_n]$, otherwise we set $[q_{n+1},
  r_{n+1}] \defeq [q_n, t]$.

  The sequences $q_0, q_1, \ldots$ and $r_0, r_1, \ldots$ are both Cauchy and they
  converge to a point $x : [0,1]$ which is contained in every $[q_n, r_n]$.
  There merely exists $i : I$ such that $a_i < x < b_i$. Because the sizes of the
  intervals $[q_n, r_n]$ shrink to zero, there is $n : \N$ such that $a_i < q_n \leq x
  \leq r_n < b_i$, but this means that $[q_n, r_n]$ is covered by a single interval $(a_i,
  b_i)$, while at the same time it has no finite subcover. A contradiction.
\end{proof}

Without excluded middle, or a pinch of Brouwerian Intuitionism, we seem to be stuck.
Nevertheless, Heine-Borel compactness of $[0,1]$ \emph{can} be recovered in a constructive
setting, in a fashion that is still compatible with classical mathematics! For this to be
done, we need to revisit the notion of cover. The trouble with
\eqref{eq:cover-pointwise-truncated} is that the truncated existential allows a space to
be covered in any haphazard way, and so computationally speaking, we stand no chance of
merely extracting a finite subcover. By removing the truncation we get
%
\begin{equation} \label{eq:cover-pointwise}
  \prd{x : [0,1]} \sm{i : I} q_i < x < r_i,
\end{equation}
%
which might help, were it not too demanding of covers. With this definition we
could not even show that $(0,3)$ and $(2,5)$ cover $[1,4]$ because that would amount
to exhibiting a non-constant map $[1,4] \to \bool$, see
\autoref{ex:reals-non-constant-into-Z}. We take a lesson from pointfree topology:
the notion of cover ought to be expressed in terms of open sets, without
reference to points. Such a ``holistic'' view of space will then allow us to analyze the
notion of cover, and we shall be able to recover Heine-Borel compactness. Since locale
theory uses powersets, which we do not have, we steal ideas from its predicative cousin,
formal topology.

Suppose that we have a family $\pairr{I, \mathcal{F}}$ and an interval $(a, b)$. How might
we express the fact that $(a,b)$ is covered by the family, without referring to points?
Here is one: if $(a, b)$ equals some $\mathcal{F}(i)$ then it is covered by the family.
And another one: if $(a,b)$ is covered by some other family $(J, \mathcal{G})$, and in
turn each $\mathcal{G}(j)$ is covered by $\pairr{I, \mathcal{F}}$, then $(a,b)$ is covered
$\pairr{I, \mathcal{F}}$. Notice that we are listing \emph{rules} which can be used to
\emph{deduce} that $\pairr{I, \mathcal{F}}$ covers $(a,b)$. We should find sufficiently
good rules and turn them into an inductive definition.

\begin{defn} \label{defn:inductive-cover}
  %
  The \define{inductive cover $\cover$} is a mere relation
  %
  \begin{equation*}
    {\cover} : (\Q \times \Q) \to (\sm{I : \type} (I \to \Q \times \Q)) \to \prop
  \end{equation*}
  %
  defined inductively by the following rules, where $q, r, s, t$ are rational numbers and
  $\pairr{I, \mathcal{F}}$, $\pairr{J, \mathcal{G}}$ are families of basic intervals:
  %
  \begin{enumerate}

  \item \emph{relexivity:} $\mathcal{F}(i) \cover \pairr{I, \mathcal{F}}$ for all $i : I$,
      
  \item \emph{transitivity:}
    if $(q, r) \cover \pairr{J, \mathcal{G}}$ and $\fall{j : J} \mathcal{G}(j) \cover \pairr{I,\mathcal{F}}$
    then $(q, r) \cover \pairr{I, \mathcal{F}}$,

  \item \emph{monotonicity:}
    if $(q, r) \subseteq (s, t)$ and $(s,t) \cover \pairr{I, \mathcal{F}}$ then $(q, r) \cover
    \pairr{I, \mathcal{F}}$,

  \item \emph{localization:}
    if $(q, r) \cover (I, \mathcal{F})$ then $(q, r) \cap (s, t) \cover
    \intfam{i}{I}{(\mathcal{F}(i) \cap (s, t))}$.

  \item \label{defn:inductive-cover-interval-1}
    if $q < s < t < r$ then $(q, r) \cover [(q, t), (r, s)]$,

  \item $(q, r) \cover \intfam{u}{\setof{ \Q \times \Q | q < s < t < r}}{u}$.
  \end{enumerate}
\end{defn}

The definition should be read as a higher-inductive type in which the listed rules are
point constructors, and the type is $(-1)$-truncated. The first four clauses are of a
general nature and should be intuitively clear. The last two clauses are specific to the
real line: one says that an interval may be covered by two intervals if they overlap,
while the other one says that an interval may be covered from within. Incidentally, if $r
\leq q$ then $(q, r)$ is covered by the empty family by the last clause.

Experience from formal topology shows that the rules for inductive covers are sufficient
for a constructive development of pointfree topology. But we can also provide our own
evidence that they are a reasonable notion.

\begin{thm} \label{inductive-cover-classical}
  \mbox{}
  %
  \begin{enumerate}
  \item An inductive cover is also a pointwise cover.
  \item Assuming excluded middle, a pointwise cover is also an inductive cover.
  \end{enumerate}
\end{thm}

\begin{proof}
  \mbox{}
  %
  \begin{enumerate}

  \item 
    Consider a family of basic intervals $\pairr{I, \mathcal{F}}$, where we write $(q_i,
    r_i) \defeq \mathcal{F}(i)$, an interval $(a,b)$ inductively covered by $\pairr{I,
      \mathcal{F}}$, and $x$ such that $a < x < b$.
    %
    We prove by induction on $(a,b) \cover \pairr{I, \mathcal{F}}$ that there merely
    exists $i : I$ such that $q_i < x < r_i$. Most cases are pretty obvious, so we show
    just two. If $(a,b) \cover \pairr{I, \mathcal{F}}$ by reflexivity, then there merely
    is some $i : I$ such that $(a,b) = (q_i, r_i)$ and so $q_i < x < r_i$. If $(a,b)
    \cover \pairr{I, \mathcal{F}}$ by transitivity via $\intfam{j}{J}{(s_j, t_j)}$ then by
    induction hypothesis there merely is $j : J$ such that $s_j < x < t_j$, and then since
    $(s_j, t_j) \cover \pairr{I, \mathcal{F}}$ again by induction hypothesis there merely
    exists $i : I$ such that $q_i < x < r_i$. Other cases are just as exciting.

  \item 
    Suppose $\intfam{i}{I}{(q_i, r_i)}$ pointwise covers $(0, 1)$. By
    \autoref{classical-Heine-Borel} there is a finite subfamily $[i_1, \ldots, i_n]$ which
    already pointwise covers $(0, 1)$. Let $\epsilon : \Qp$ be a Lebesgue number for
    $(q_{i_1}, r_{i_1}), \ldots, (q_{i_n}, r_{i_n})$ as in
    \autoref{ex:finite-cover-lebesgue-number}. There is a positive $k : \N$ such that $2/k <
    \min(1, \epsilon)$. The intervals $(i/k, (i+2)/k)$, where $i$ ranges over $0, \ldots,
    k-2$, inductively cover $(0,1)$ by repeated use of transitivity
    and~\autoref{defn:inductive-cover-interval-1} in \autoref{defn:inductive-cover}.
    Because each of them is contained in some $(q_i, r_i)$ we may use transitivity and
    monotonicity to conclude that $\intfam{i}{I}{(q_i, r_i)}$ inductively cover $(0, 1)$.
    \qedhere
  \end{enumerate}
\end{proof}

The upshot of the previous theorem is that, as far as classical mathematics is concerned,
there is no difference between a pointwise and an inductive cover. In particular, since it
is consistent to assume excluded middle in homotopy type theory, we cannot exhibit an
inductive cover which fails to be a pointwise cover. Or to put it in a different way, the
difference between pointwise and inductive covers is not what they cover but in the
\emph{proofs} that they cover. In any case, inductive covers enjoy the Heine-Borel
property.

\begin{lem} \label{reals-formal-topology-locally-compact}
  Suppose $q < s < t < r$ and $(q, r) \cover \pairr{I, \mathcal{F}}$. Then there merely
  exists a finite subfamily of $\pairr{I, \mathcal{F}}$ which inductively covers $(s, t)$.
\end{lem}

\begin{proof}
  We prove the statement by induction on $(q, r) \cover \pairr{I, \mathcal{F}}$. There are
  six cases:
  %
  \begin{enumerate}

  \item Reflexivity: if $(q, r) = \mathcal{F}(i)$ then by monotonicity $(s, t)$ is covered
    by the finite subfamily $[\mathcal{F}(i)]$.

  \item Transitivity:
    suppose $(q, r) \cover \pairr{J, \mathcal{G}}$ and $\fall{j}{J} \mathcal{G}(j) \cover
    \pairr{I, \mathcal{F}}$. By induction hypothesis there merely exists a finite
    subfamily $[\mathcal{G}(j_1), \ldots, \mathcal{G}(j_n)]$ which covers $(s, t)$.
    Again by induction hypothesis, each of $\mathcal{G}(j_k)$ is covered by a finite
    subfamily of $\pairr{I, \mathcal{F}}$, and we can collect these into a finite
    subfamily which covers $(s, t)$.

  \item Monotonicity:
    if $(q, r) \subseteq (u, v)$ and $(u, v) \cover \pairr{I, \mathcal{F}}$ then we may
    apply the induction hypothesis to $(u, v) \cover \pairr{I, \mathcal{F}}$ because $u <
    s < t < v$.

  \item Localization:
    suppose $(q', r') \cover \pairr{I, \mathcal{F}}$ and $(q, r) = (q', r') \cap (a, b)$.
    Because $q' < s < t < r'$, by induction hypothesis there is a finite subcover
    $[\mathcal{F}(i_1), \ldots, \mathcal{F}(i_n)]$ of $(s, t)$. We also know that $a < s <
    t < b$, therefore $(s, t) = (s, t) \cap (a, b)$ is covered by
    $[\mathcal{F}(i_1) \cap (a,b), \ldots, \mathcal{F}(i_n) \cap (a,b)]$, which is a
    finite subfamily of $\intfam{i}{I}{(\mathcal{F}(i) \cap (a, b))}$.

  \item If $(q, r) \cover [(q, v), (u, r)]$ for some $q < u < v < r$ then by monotonicity
    $(s, t) \cover [(q, v), (u, r)]$.

  \item Finally, $(s, t) \cover \intfam{u}{\setof{ \Q \times \Q | q < u < v < r}}{z}$ by
    reflexivity. \qedhere
  \end{enumerate}
\end{proof}

Finally, we are ready to prove that the closed interval is Heine-Borel compact with
respect to inductive covers. Say that \define{$\pairr{I, \mathcal{F}}$ inductively covers
  $[a, b]$} when there merely exists $\epsilon : \Qp$ such that $(a - \epsilon, b +
\epsilon) \cover \pairr{I, \mathcal{F}}$.

\begin{cor} \label{interval-Heine-Borel}
  A closed interval is Heine-Borel compact for inductive covers.
\end{cor}

\begin{proof}
  Suppose $[a, b]$ is inductively covered by $\pairr{I, \mathcal{F}}$, so there merely is
  $\epsilon : \Qp$ such that $(a - \epsilon, b + \epsilon) \cover \pairr{I, \mathcal{F}}$.
  By \autoref{reals-formal-topology-locally-compact} there is a finite subcover of
  $(a - \epsilon/2, b + \epsilon/2)$, which is therefore a finite subcover of $[a, b]$.
\end{proof}

We could write another book by going on like this, but let us stop here and hope that we
have provided ample justification for the claim that analysis can be developed in homotopy
type theory. The curious reader should consult \autoref{ex:mean-value-theorem} for
constructive versions of the Mean Value Theorem.

\section{The surreal numbers}
\label{sec:surreals}

In this section we consider another example of a higher inductive-inductive type, which draws together many of our threads: Conway's field \NO of \emph{surreal numbers}~\cite{conway:onag}.
The surreal numbers are the natural common generalization of the (Dedekind) real numbers (\autoref{sec:dedekind-reals}) and the ordinal numbers (\autoref{sec:ordinals}).
Conway, working in classical mathematics with excluded middle and Choice, defines a surreal number to be a pair of \emph{sets} of surreal numbers, written $\surr L R$, such that every element of $L$ is strictly less than every element of $R$.
This obviously looks like an inductive definition, but there are three issues with regarding it as such.

Firstly, the definition requires the relation of (strict) inequality between surreals, so that relation must be defined simultaneously with the type \NO of surreals.
(Conway avoids this issue by first defining \emph{games}, which are like surreals but omit the compatibility condition on $L$ and $R$.)
As with the relation $\sim$ for the Cauchy reals, this simultaneous definition could \emph{a priori} be either inductive-inductive or inductive-recursive.
We will choose to make it inductive-inductive, for the same reasons we made that choice for $\sim$.

Moreover, we will define strict inequality $<$ and non-strict inequality $\le$ for surreals separately (and mutually inductively).
Conway defines $<$ in terms of $\le$, in a way which is sensible classically but not constructively.
Furthermore, a negative definition of $<$ would make it unacceptable as a hypothesis of the constructor of a higher inductive type (see \autoref{sec:strictly-positive}).

Secondly, Conway says that $L$ and $R$ in $\surr L R$ should be ``sets of surreal numbers'', but the naive meaning of this as a predicate $\NO\to\prop$ is not positive, hence cannot be used as input to an inductive constructor.
However, this would not be a good type-theoretic translation of what Conway means anyway, because in set theory the surreal numbers form a proper class, whereas the sets $L$ and $R$ are true (small) sets, not arbitrary subclasses of \NO.
In type theory, this means that \NO will be defined relative to a universe \UU, but will itself belong to the next higher universe $\UU'$, like the sets \ord and \card of ordinals and cardinals, the cumulative hierarchy $V$, or even the Dedekind reals in the absence of propositional resizing.
We will then require the ``sets'' $L$ and $R$ of surreals to be \UU-small, and so it is natural to represent them by \emph{families} of surreals indexed by some \UU-small type.
(This is all exactly the same as what we did with the cumulative hierarchy in \autoref{sec:cumulative-hierarchy}.)
That is, the constructor of surreals will have type
\[ \prd{\LL,\RR:\UU} (\LL\to\NO) \to (\RR\to \NO) \to (\text{some condition}) \to \NO \]
which is indeed strictly positive.

Finally, after giving the mutual definitions of \NO and its ordering, Conway declares two surreal numbers $x$ and $y$ to be \emph{equal} if $x\le y$ and $y\le x$.
This is naturally read as passing to a quotient of the set of ``pre-surreals'' by an equivalence relation.
%(In set-theoretic foundations, one has to us an additional trick to deal with large equivalence classes.)
However, in the absence of the axiom of choice, such a quotient presents the same problem as the quotient in the usual construction of Cauchy reals: it will no longer be the case that a pair of families \emph{of surreals} yield a new surreal $\surr L R$, since we cannot necessarily ``lift'' $L$ and $R$ to families of pre-surreals.
Of course, we can solve this problem in the same way we did for Cauchy reals, by using a \emph{higher} inductive-inductive definition.

\begin{defn}
  The type \NO of \define{surreal numbers}, along with the relations $\mathord<:\NO\to\NO\to\type$ and $\mathord\le:\NO\to\NO\to\type$, are defined higher inductive-inductively as follows.
  The type \NO has the following constructors.
  \begin{itemize}
  \item For any $\LL,\RR:\UU$ and functions $\LL\to \NO$ and $\RR\to \NO$, whose values we write as $x^L$ and $x^R$ for $L:\LL$ and $R:\RR$ respectively, if $\fall{L:\LL}{R:\RR} x^L<x^R$, then there is a surreal number $x$.
  \item For any $x,y:\NO$ such that $x\le y$ and $y\le x$, we have $x=y$.
  \end{itemize}
  We will refer to the inputs of the first constructor as a \emph{cut}.
  If $x$ is the surreal number constructed from a cut, then the notation $x^L$ will implicitly assume $L:\LL$, and similarly $x^R$ will assume $R:\RR$.
  In this way we can usually avoid naming the indexing types $\LL$ and $\RR$, which is convenient when there are many different cuts under discussion.
  Following Conway, we call $x^L$ a \emph{left option} of $x$ and $x^R$ a \emph{right option}.

  The path-constructor implies that different cuts can define the same surreal number.
  Thus, it does not make sense to speak of the left or right options of an arbitrary surreal number $x$, unless we also know that $x$ is defined by a particular cut.
  Thus in what follows we will say, for instance, ``given a cut defining a surreal number $x$'' in contrast to ``given a surreal number $x$''.

  The relation $\le$ has the following constructors.
  \begin{itemize}
  \item Given cuts defining two surreal numbers $x$ and $y$, if $x^L<y$ for all $L$, and $x<y^R$ for all $R$, then $x\le y$.
  \item Propositional truncation:\footnote{This constructor may not be necessary ($\le$ might turn out to be a mere relation automatically), but we include it for convenience.}
    for any $x,y:\NO$, if $p,q:x\le y$, then $p=q$.
  \end{itemize}
  And the relation $<$ has the following constructors.
  \begin{itemize}
    % Don't technically need x in the first one and y in the second one to be defined by cuts?
  \item Given cuts defining two surreal numbers $x$ and $y$, if there is an $L$ such that $x\le y^L$, then $x<y$.
  \item Given cuts defining two surreal numbers $x$ and $y$, if there is an $R$ such that $x^R\le y$, then $x<y$.
  \item Propositional truncation: for any $x,y:\NO$, if $p,q:x<y$, then $p=q$.
  \end{itemize}
\end{defn}

\noindent
We compare this with Conway's definitions:
\begin{itemize}\footnotesize
\item[-] If $L,R$ are any two sets of numbers, and no member of $L$ is $\ge$ any member of $R$, then there is a number $\surr L R$.
  All numbers are constructed in this way.
\item[-] $x\ge y$ iff (no $x^R\le y$ and $x\le$ no $y^L$).
\item[-] $x=y$ iff ($x \ge y$ and $y\ge x$).
\item[-] $x>y$ iff ($x\ge y$ and $y\not\ge x$).
\end{itemize}
The inclusion of $x\ge y$ in the definition of $x>y$ is unnecessary if all objects are [surreal] numbers rather than ``games''.
Thus, Conway's $<$ is just the negation of his $\le$, so that his condition for $\surr L R$ to be a surreal is the same as ours.
Negating Conway's $\le$ and canceling double negations, we arrive at our definition of $<$, and we can then reformulate his $\le$ in terms of $<$ without negations.

We can immediately populate $\NO$ with many surreal numbers.
Like Conway, we write
\[\surr{x,y,z,\dots}{u,v,w,\dots}\]
for the surreal number defined by a cut where $\LL\to\NO$ and $\RR\to\NO$ are families described by $x,y,z,\dots$ and $u,v,w,\dots$.
Of course, if $\LL$ or $\RR$ are $\emptyt$, we leave the corresponding part of the notation empty.
There is an unfortunate clash with the standard notation $\setof{x:A | P(x)}$ for subsets, but we will not use the latter in this section.
\begin{itemize}
\item We define $\iota_{\nat}:\nat\to\NO$ recursively by
  \begin{align*}
    \iota_{\nat}(0) &\defeq \surr{}{}\\
    \iota_\nat(\suc(n)) &\defeq \surr{\iota_\nat(n)}{}
  \end{align*}
  That is, $\iota_\nat(0)$ is defined by the cut consisting of $\emptyt\to\NO$ and $\emptyt\to\NO$.
  Similarly, $\iota_\nat(\suc(n))$ is defined by $\unit\to\NO$ (picking out $\iota_\nat(n)$) and $\emptyt\to\NO$.
\item Similarly, we define $\iota_{\Z}:\Z\to\NO$ using the sign-case recursion principle:
  \begin{alignat*}{2}
    \iota_{\Z}(0) &\defeq \surr{}{}\\
    \iota_\Z(n+1) &\defeq \surr{\iota_\Z(n)}{} &&\quad n\ge 0\\
    \iota_\Z(n-1) &\defeq \surr{}{\iota_\Z(n)} &&\quad n\le 0
  \end{alignat*}
\item By a \emph{dyadic rational} we mean a pair $(a,n)$ where $a:\Z$ and $n:\nat$, and such that if $n>0$ then $a$ is odd.
  We will write it as $a/2^n$, and identify it with the corresponding rational number.
  If $\Q_D$ denotes the set of dyadic rationals, we define $\iota_{\Q_D}:\Q_D\to\NO$ by induction on $n$:
  \begin{align*}
    \iota_{\Q_D}(a/2^0) &\defeq \iota_\Z(a)\\
    \iota_{\Q_D}(a/2^n) &\defeq \surr{a/2^n - 1/2^n}{a/2^n + 1/2^n} \quad n>0
  \end{align*}
  Here we use the fact that if $n>0$ and $a$ is odd, then $a/2^n \pm 1/2^n$ is a dyadic rational with a smaller denominator than $a/2^n$.
\item We define $\iota_{\RD}:\RD\to\NO$, where $\RD$ is (any version of) the Dedekind reals from \autoref{sec:dedekind-reals}, by
  \begin{align*}
    \iota_{\RD}(x) &\defeq
    \surr{q\in\Q_D \text{ such that } q<x}{q\in\Q_D \text{ such that } x<q}
  \end{align*}
  Unlike in the previous cases, it is not obvious that this extends $\iota_{\Q_D}$ when we regard dyadic rationals as Dedekind reals.
  This follows from the simplicity theorem (\autoref{thm:NO-simplicity}).
\item Recall the type \ord of \emph{ordinals} from \autoref{sec:ordinals}, which is well-ordered by the relation $<$, where $A<B$ means that $A = \ordsl B b$ for some $b:B$.
  We define $\iota_{\ord}:\ord\to\NO$ by well-founded recursion (\autoref{thm:wfrec}) on $\ord$:
  \begin{align*}
    \iota_{\ord}(A) &\defeq
    \surr{\iota_\ord(\ordsl A a) \text{ for all } a:A}{}
  \end{align*}
  It will also follow from the simplicity theorem that $\iota_\ord$ restricted to finite ordinals agrees with $\iota_\nat$.
\item A few more interesting examples taken from Conway:
  \begin{align*}
    \omega &\defeq \surr{0,1,2,3,\dots}{} \qquad\text{(also an ordinal)}\\
    -\omega &\defeq \surr{}{\dots,-3,-2,-1,0}\\
    1/\omega &\defeq \textstyle\surr{0}{1,\frac12,\frac14,\frac18,\dots}\\
    \omega-1 &\defeq \surr{0,1,2,3,\dots}{\omega}\\
    \omega/2 &\defeq \surr{0,1,2,3,\dots}{\dots,\omega-2,\omega-1,\omega}.
  \end{align*}
\end{itemize}

In identifying surreal numbers presented by different cuts, the following simple observation is useful.

\begin{thm}[Conway's Simplicity Theorem]\label{thm:NO-simplicity}
  Suppose $x$ and $z$ are surreal numbers defined by cuts, and that the following hold.
  \begin{itemize}
  \item $x^L < z < x^R$ for all $L$ and $R$.
  \item For every left option $z^L$ of $z$, there exists a left option $x^{L'}$ with $z^L\le x^{L'}$.
  \item For every right option $z^R$ of $z$, there exists a right option $x^{R'}$ with $x^{R'}\le z^R$.
  \end{itemize}
  Then $x=z$.
\end{thm}
\begin{proof}
  Applying the path-constructor of $\NO$, we must show $x\le z$ and $z\le x$.
  The first entails showing $x^L<z$ for all $L$, which we assumed, and $x<z^R$ for all $R$.
  But by assumption, for any $z^R$ there is an $x^{R'}$ with $x^{R'}\le z^R$ hence $x<z^R$ as desired.
  Thus $x\le z$; the proof of $z\le x$ is symmetric.
\end{proof}

In order to say much more about surreal numbers, however, we need their induction principle.
The mutual induction principle for $(\NO,\le,<)$ applies to three families of types:
\begin{align*}
  A &: \NO\to\type\\
  B &: \prd{x,y:\NO}{a:A(x)}{b:A(y)} (x\le y) \to \type\\
  C &: \prd{x,y:\NO}{a:A(x)}{b:A(y)} (x<y) \to \type.
\end{align*}
It requires the following hypotheses:
\begin{itemize}
\item For any cut defining a surreal number $x$, together with
  \begin{enumerate}
  \item for each $L$, an element $a^L:A(x^L)$, and
  \item for each $R$, an element $a^R:A(x^R)$, such that
  \item for all $L$ and $R$ we have $C(x^L,x^R,a^L,a^R,\blank)$
  \end{enumerate}
  there is a specified element $f_a:A(x)$.
  We call such data a \emph{dependent cut} over the cut defining~$x$.
\item For any $x,y:\NO$ with $a:A(x)$ and $b:A(y)$, if $x\le y$ and $y\le x$ and also $B(x,y,a,b,\blank)$ and $B(y,x,b,a,\blank)$, then $\dpath{A}{\blank}{a}{b}$.
\item Given cuts defining two surreal numbers $x$ and $y$, and dependent cuts $a$ over $x$ and $b$ over $y$, such that for all $L$ we have $x^L<y$ and $C(x^L,y,a^L,b,\blank)$, and for all $R$ we have $x<y^R$ and $C(x,y^R,a,b^R,\blank)$, then $B(x,y,a,b,\blank)$.
\item $B$ is a family of mere propositions.
\item Given cuts defining two surreal numbers $x$ and $y$, dependent cuts $a$ over $x$ and $b$ over $y$, and an $L_0$ such that $x\le y^{L_0}$ and $B(x,y^{L_0},a,b^{L_0},\blank)$, we have $C(x,y,a,b,\blank)$.
\item Given cuts defining two surreal numbers $x$ and $y$, dependent cuts $a$ over $x$ and $b$ over $y$, and an ${R_0}$ such that $x^{R_0}\le y$ and $B(x^{R_0},y,a^{R_0},b,\blank)$, we have $C(x,y,a,b,\blank)$.
\item $C$ is a family of mere propositions.
\end{itemize}
Under these hypotheses we deduce a function $f:\prd{x:\NO} A(x)$ such that
\begin{align*}
  (x\le y) &\to B(x,y,f(x),f(y),\blank)\\
  (x< y) &\to C(x,y,f(x),f(y),\blank).
\end{align*}
Its computation rule on the point-constructor can be written as $f(x) \jdeq f_{f[x]}$, where $x$ is a surreal number defined by a cut, and $f[x]$ denotes the dependent cut over $x$ defined by applying $f$ (and using the fact that $f$ takes $<$ to $C$).

As with the Cauchy reals, we have special cases resulting from trivializing some of $A$, $B$, and~$C$.
Taking $B$ and $C$ to be constant at \unit, we have \emph{\NO-induction}, which for simplicity we state only for mere properties:
\begin{itemize}
\item Given $P:\NO\to\prop$, if $P(x)$ holds whenever $x$ is a surreal number defined by a cut such that $P(x^L)$ and $P(x^R)$ hold for all
$L$ and $R$, then $P(x)$ holds for all $x:\NO$.
\end{itemize}
This should be compared with Conway's remark:
\begin{quote}\footnotesize
  In general when we wish to establish a proposition $P(x)$ for all numbers $x$, we will prove it inductively by deducing $P(x)$ from the truth of all the propositions $P(x^L)$ and $P(x^R)$.
  We regard the phrase ``all numbers are constructed in this way'' as justifying the legitimacy of this procedure.
\end{quote}
With $\NO$-induction, we can prove

\begin{thm}[Conway's Theorem 0]\label{thm:NO-refl-opt}\ 
  \begin{enumerate}
  \item For any $x:\NO$, we have $x\le x$.\label{item:NO-le-refl}
  \item For any $x:\NO$ defined by a cut, we have $x^L <x$ and $x<x^R$ for all $L$ and $R$.\label{item:NO-lt-opt}
  \end{enumerate}
\end{thm}
\begin{proof}
  Note first that if $x\le x$, then whenever $x$ occurs as a left option of some cut $y$, we have $x<y$ by the first constructor of $<$, and similarly whenever $x$ occurs as a right option of a cut $y$, we have $y<x$ by the second constructor of $<$.
  In particular,~\ref{item:NO-le-refl}$\Rightarrow$\ref{item:NO-lt-opt}.

  We prove~\ref{item:NO-le-refl} by $\NO$-induction on $x$.
  Thus, assume $x$ is defined by a cut such that $x^L\le x^L$ and $x^R \le x^R$ for all $L$ and $R$.
  But by our observation above, these assumptions imply $x^L<x$ and $x<x^R$ for all $L$ and $R$, yielding $x\le x$ by the constructor of $\le$.
\end{proof}

\begin{cor}\label{thm:NO-set}
  \NO is a 0-type.
%  (As with $V$, it might be confusing to say that it is a ``set''.)
\end{cor}
\begin{proof}
  The mere relation $R(x,y)\defeq (x\le y) \land (y\le x)$ implies identity by the path-constructor of $\NO$, and contains the diagonal by \autoref{thm:NO-refl-opt}\ref{item:NO-le-refl}.
  Thus, \autoref{thm:h-set-refrel-in-paths-sets} applies.
\end{proof}

By contrast, Conway's Theorem 1 (transitivity of $\le$) is somewhat harder to establish with our definition; see \autoref{thm:NO-unstrict-transitive}.

% Of course, we also have:

% \begin{lem}
%   Every surreal number is merely defined by a cut.
% \end{lem}
% \begin{proof}
%   Obvious by $\NO$-induction.
% \end{proof}

We will also need the joint recursion principle, \emph{$(\NO,\le,<)$-recursion}, which it is convenient to state as follows.
Suppose $A$ is a type equipped with relations $\mathord\ble:A\to A\to\prop$ and $\mathord\blt:A\to A\to\prop$.
Then we can define $f:\NO\to A$ by doing the following.
\begin{enumerate}
\item For any $x$ defined by a cut, assuming $f(x^L)$ and $f(x^R)$ to be defined such that $f(x^L)\blt f(x^R)$ for all $L$ and $R$, we must define $f(x)$.  (We call this the \emph{primary clause} of the recursion.)\label{item:NO-rec-primary}
\item Prove that $\ble$ is \emph{antisymmetric}: if $a\ble b$ and $b\ble a$, then $a=b$.
\item For $x,y$ defined by cuts such that $x^L<y$ for all $L$ and $x<y^R$ for all $R$, and assuming inductively that $f(x^L)\blt f(y)$ for all $L$, $f(x)\blt f(y^R)$ for all $R$, and also that $f(x^L)\blt f(x^R)$ and $f(y^L)\blt f(y^R)$ for all $L$ and $R$, we must prove $f(x)\ble f(y)$.
\item For $x,y$ defined by cuts and an $L_0$ such that $x\le y^{L_0}$, and assuming inductively that $f(x)\ble f(y^{L_0})$, and also that $f(x^L)\blt f(x^R)$ and $f(y^L)\blt f(y^R)$ for all $L$ and $R$, we must prove $f(x)\blt f(y)$.
\item For $x,y$ defined by cuts and an $R_0$ such that $x^{R_0}\le y$, and assuming inductively that $f(x^{R_0})\ble f(y)$, and also that $f(x^L)\blt f(x^R)$ and $f(y^L)\blt f(y^R)$ for all $L$ and $R$, we must prove $f(x)\blt f(y)$.\label{item:NO-rec-last}
\end{enumerate}
The last three clauses can be more concisely described by saying we must prove that $f$ (as defined in the first clause) takes $\le$ to $\ble$ and $<$ to $\blt$.
We will refer to these properties by saying that \emph{$f$ preserves inequalities}.
Moreover, in proving that $f$ preserves inequalities, we may assume the particular instance of $\le$ or $<$ to be obtained from one of its constructors, and we may also use inductive hypotheses that $f$ preserves all inequalities appearing in the input to that constructor.

If we succeed at~\ref{item:NO-rec-primary}--\ref{item:NO-rec-last} above, then we obtain $f:\NO\to A$, which computes on cuts as specified by~\ref{item:NO-rec-primary}, and which preserves all inequalities:
\[ \fall{x,y:\NO}\Big((x\le y) \to (f(x)\ble f(y))\Big) \land\Big((x< y) \to (f(x)\blt f(y))\Big).\]
Like $(\RC,\sim)$-recursion for the Cauchy reals, this recursion principle is essential for defining functions on $\NO$, since we cannot first define a function on ``pre-surreals'' and only later prove that it respects the notion of equality.

\begin{eg}
  Let us define the \emph{negation} function $\NO\to\NO$.
  We apply the joint recursion principle with $A\defeq\NO$, with $(x\ble y)\defeq (y\le x)$, and $(x\blt y)\defeq (y< x)$.
  Clearly this $\ble$ is antisymmetric.

  For the main clause in the definition, we assume $x$ defined by a cut, with $-x^L$ and $-x^R$ defined such that $-x^L \blt -x^R$ for all $L$ and $R$.
  By definition, this means $-x^R< -x^L$ for all $L$ and $R$, so we can define $-x$ by the cut $\surr{-x^R}{-x^L}$.
  This notation, which follows Conway, refers to the cut whose left options are indexed by the type $\RR$ indexing the right options of $x$, and whose right options are indexed by the type $\LL$ indexing the left options of $x$, with the corresponding families $\RR\to\NO$ and $\LL\to\NO$ defined by composing those for $x$ with negation.

  We now have to verify that $f$ preserves inequalities.
  \begin{itemize}
  \item For $x\le y$, we may assume $x^L<y$ for all $L$ and $x < y^R$ for all $R$, and show $-y\le -x$.
    But inductively, we may assume $-y <-x^L$ and $-y^R<-x$, which gives the desired result, by definition of $-y$, $-x$, and the constructor of $\le$.
  \item For $x<y$, in the first case when it arises from some $x\le y^{L_0}$, we may inductively assume $-y^{L_0} \le -x$, in which case $-y<-x$ follows by the constructor of $<$.
  \item Similarly, if $x<y$ arises from $x^{R_0}\le y$, the induction hypothesis is $-y \le -x^R$, yielding $-y<-x$ again.
  \end{itemize}
\end{eg}

To do much more than this, however, we will need to characterize the relations $\le$ and $<$ more explicitly, as we did for the Cauchy reals in \autoref{thm:RC-sim-characterization}.
Also as there, we will have to simultaneously prove a couple of essential properties of these relations, in order for the induction to go through.

\begin{thm}\label{defn:No-codes}
  There are relations $\mathord\preceq:\NO\to\NO\to\prop$ and $\mathord\prec:\NO\to\NO\to\prop$ such that if $x$ and $y$ are surreals defined by cuts, then
  \begin{align*}
    (x\preceq y) &\defeq
    \big(\fall{L} x^L\prec y\big) \land \big(\fall{R} x\prec y^R\big)\\
    (x\prec y) &\defeq
    \big(\exis{L} x\preceq y^L\big) \lor \big(\exis{R} x^R \preceq y\big).
  \end{align*}
  Moreover, we have
  \begin{equation}\label{eq:NO-codes-unstrict}
    (x\prec y) \to (x\preceq y)
  \end{equation}
  and all the reasonable transitivity properties making $\prec$ and $\preceq$ into a ``bimodule'' over $\le$ and $<$:
  \begin{equation}\label{eq:NO-codes-transitivity}
    \begin{array}{c@{\hspace{1cm}}c}
      (x \le y) \to (y\preceq z) \to (x\preceq z) &
      (x \preceq y) \to (y\le z) \to (x\preceq z) \\
      (x \le y) \to (y\prec z) \to (x\prec z) &
      (x \preceq y) \to (y< z) \to (x\prec z) \\
      (x < y) \to (y\preceq z) \to (x\prec z) &
      (x \prec y) \to (y\le z) \to (x\prec z) % \\
      % (x < y) \to (y\prec z) \to (x\prec z) &
      % (x \prec y) \to (y< z) \to (x\prec z) 
  \end{array}
  \end{equation}
\end{thm}

\begin{proof}
  We define $\preceq$ and $\prec$ by double $(\NO,\le,<)$-induction on $x,y$.
  The first induction is a simple recursion, whose codomain is the subset $A$ of $(\NO\to\prop)\times (\NO\to\prop)$ consisting of pairs of predicates of which one implies the other and which satisfy ``transitivity on the right'', i.e.~\eqref{eq:NO-codes-unstrict} and the right column of~\eqref{eq:NO-codes-transitivity} with $(x\preceq -)$ and $(x\prec -)$ replaced by the two given predicates.
  As in the proof of \autoref{defn:RC-approx}, we regard these predicates as half of binary relations, writing them as $y\mapsto (\hle y)$ and $y\mapsto (\hlt y)$, with $\hlname$ denoting the pair of relations.
  % The precise definition of $A$ is
  % \begin{align*}
  %   A\defeq \bigg\{ \hlname : (\NO\to\prop)\times (\NO\to\prop) \;\bigg|\;\\
  %   \begin{split}
  %     \fall{y,z:\NO}
  %     &\Big( (\hle y) \to (y\le z) \to (\hle z) \Big)\\
  %     \land\; &\Big( (\hle y) \to (y< z) \to (\hlt z) \Big)\\
  %     \land\; &\Big( (\hlt y) \to (y\le z) \to (\hlt z) \Big)\\
  %     \land\; &\Big( (\hlt y) \to (y< z) \to (\hlt z) \Big) \bigg\}
  %   \end{split}
  % \end{align*}
  We equip $A$ with the following two relations:
  \begin{align*}
    (\hlname \ble \hlbname) &\defeq
    \fall{y:\NO} \Big( (\hleb y) \to (\hle y) \Big) \land
    \Big( (\hltb y) \to (\hlt y) \Big)\\
    (\hlname \blt \hlbname) &\defeq
    \fall{y:\NO} \Big( (\hleb y) \to (\hlt y) \Big)
    %\land \Big( (\hltb y) \to (\hlt y) \Big)
  \end{align*}
  Note that $\ble$ is antisymmetric, since if $\hlname \ble \hlbname$ and $\hlbname \ble \hlname$, then $(\hleb y) \leftrightarrow (\hle y)$ and $(\hltb y) \leftrightarrow (\hlt y)$ for all $y$, hence $\hlname=\hlbname$ by univalence for mere propositions and function extensionality.
  Moreover, to say that a function $\NO\to A$ preserves inequalities is exactly to say that, when regarded as a pair of binary relations on $\NO$, it satisfies ``transitivity on the left'' (the left column of~\eqref{eq:NO-codes-transitivity}).

  Now for the primary clause of the recursion, we assume given $x$ defined by a cut, and relations $(x^L \prec -)$, $(x^R \prec -)$, $(x^L \preceq -)$, and $(x^R \preceq -)$ for all $L$ and $R$, of which the strict ones imply the non-strict ones, which satisfy transitivity on the right, and such that
  \begin{equation}\label{eq:NO-prec-outer-IH}
    \fall{L,R}{y:\NO}\Big( (x^R\preceq y) \to (x^L \prec y) \Big)
    % \land\Big( (x^R \prec y) \to (x^L \prec y) \Big)
  \end{equation}
  We now have to define $(x\prec y)$ and $(x\preceq y)$ for all $y$.
  Here in contrast to \autoref{defn:RC-approx}, rather than a nested recursion, we use a nested induction, in order to be able to inductively use transitivity on the left with respect to the inequalities $x^L<x$ and $x<x^R$.
  Define $A':\NO\to\type$ by taking $A'(y)$ to be the subset $A'$ of $\prop\times\prop$ consisting of two mere propositions, denoted $\tle y$ and $\tlt y$ (with $\tlname:A'(y)$), such that
  \begin{gather}
    (\tlt y) \to (\tle y)\\
    \fall{L} (\tle y)\to (x^L\prec y) \label{eq:NO-prec-IHL}\\
    \fall{R} (x^R \preceq y) \to (\tlt y) \label{eq:NO-prec-IHR}.
  \end{gather}
  Using notation analogous to $\ble$ and $\blt$ for recursion, we equip $A'$ with the two relations defined for $\tlname:A'(y)$ and $\tlbname:A'(z)$ by
  \begin{align*}
    (\tlname \bble \tlbname) &\defeq
    \Big((\tle y) \to (\tleb z)\Big) \land \Big((\tlt y) \to (\tltb z)\Big)\\
    (\tlname \bblt \tlbname) &\defeq
    \Big((\tle y) \to (\tltb z)\Big). % \land \Big(\tlt \to \tltb\Big).
  \end{align*}
  (These are the type families $B$ and $C$ in the general induction principle.)
  Again, $\bble$ is evidently antisymmetric in the appropriate sense.
  Moreover, a function $\prd{y:\NO} A'(y)$ which preserves inequalities is precisely a pair of predicates of which one implies the other, which satisfy transitivity on the right, and transitivity on the left with respect to the inequalities $x^L<x$ and $x<x^R$.
  Thus, this inner induction will provide what we need to complete the primary clause of the outer recursion.

  For the primary clause of the inner induction, we assume also given $y$ defined by a cut, and properties $(x\prec y^L)$, $(x\prec y^R)$, $(x\preceq y^L)$, and $(x\preceq y^R)$ for all $L$ and $R$, with the strict ones implying the non-strict ones, transitivity on the left with respect to $x^L<x$ and $x<x^R$, and on the right with respect to $y^L<y^R$.
  % \begin{equation}
  %   \fall{L,R}\Big((x \preceq y^L) \to (x \prec y^R)\Big) % \land \Big((x \prec y^L) \to (x\prec y^R)\Big).
  %   \label{eq:NO-prec-inner-IH}
  % \end{equation}
  We can now give the definitions specified in the theorem statement:
  \begin{align}
    (x\preceq y) &\defeq
    (\fall{L} x^L\prec y) \land (\fall{R} x\prec y^R)\label{eq:NO-preceq-def}\\
    (x\prec y) &\defeq
    (\exis{L} x\preceq y^L) \lor (\exis{R} x^R \preceq y).\label{eq:NO-prec-def}
  \end{align}
  For this to define an element of $A'(y)$, we must show first that $(x\prec y) \to (x\preceq y)$.
  The assumption $x\prec y$ has two cases.
  On one hand, if there is $L_0$ with $x\preceq y^{L_0}$, then by transitivity on the right with respect to $y^{L_0}<y^R$, we have $x\prec y^R$ for all $R$.
  Moreover, by transitivity on the left with respect to $x^L<x$, we have $x^L \prec y^{L_0}$ for any $L$, hence $x^L\prec y$ by transitivity on the right.
  Thus, $x\preceq y$.

  On the other hand, if there is $R_0$ with $x^{R_0}\preceq y$, then by transitivity on the left with respect to $x^L<x^{R_0}$ we have $x^L \prec y$ for all $L$.
  And by transitivity on the left and right with respect to $x<x^{R_0}$ and $y<y^R$, we have $x\prec y^R$ for any $R$.
  Thus, $x\preceq y$.

  We also need to show that these definitions are transitive on the left with respect to $x^L<x$ and $x<x^R$.
  But if $x\preceq y$, then $x^L\prec y$ for all $L$ by definition; while if $x^R\preceq y$, then $x\prec y$ also by definition.

  Thus,~\eqref{eq:NO-preceq-def} and~\eqref{eq:NO-prec-def} do define an element of $A'(y)$.
  We now have to verify that this definition preserves inequalities, as a dependent function into $A'$, i.e.\ that these relations are transitive on the right.
  Remember that in each case, we may assume inductively that they are transitive on the right with respect to all inequalities arising in the inequality constructor.
  \begin{itemize}
  \item Suppose $x\preceq y$ and $y\le z$, the latter arising from $y^L<z$ and $y<z^R$ for all $L$ and $R$.
    Then the inductive hypothesis (of the inner recursion) applied to $y<z^R$ yields $x\prec z^R$ for any $R$.
    Moreover, by definition $x\preceq y$ implies that $x^L \prec y$ for any $L$, so by the inductive hypothesis of the outer recursion we have $x^L \prec z$.
    Thus, $x\preceq z$.
  \item Suppose $x\preceq y$ and $y<z$.
    First, suppose $y<z$ arises from $y\le z^{L_0}$.
    Then the inner inductive hypothesis applied to $y\le z^{L_0}$ yields $x \preceq z^{L_0}$, hence $x\prec z$.

    Second, suppose $y<z$ arises from $y^{R_0}\le z$.
    Then by definition, $x\preceq y$ implies $x\prec y^{R_0}$, and then the inner inductive hypothesis for $y^{R_0}\le z$ yields $x\prec z$.
  \item Suppose $x\prec y$ and $y\le z$, the latter arising from $y^L<z$ and $y<z^R$ for all $L$ and $R$.
    By definition, $x\prec y$ implies there merely exists $R_0$ with $x^{R_0}\preceq y$ or $L_0$ with $x\preceq y^{L_0}$.
    If $x^{R_0}\preceq y$, then the outer inductive hypothesis yields $x^{R_0}\preceq z$, hence $x\prec z$.
    If $x\preceq y^{L_0}$, then the inner inductive hypothesis for $y^{L_0}<z$ (which holds by the constructor of $y\le z$) yields $x\prec z$.
  % \item Suppose $x\prec y$ and $y<z$.
  %   First, suppose $y<z$ arises from $y\le z^{L_0}$.
  %   Then the inner inductive hypothesis for $y\le z^{L_0}$ yields $x\prec z^{L_0}$, hence $x\preceq z^{L_0}$; thus $x\prec z$.

  %   Second, suppose $y<z$ arises from $y^{R_0}\le z$.
  %   Then by definition, $x\prec y$ implies there merely exists $R_1$ with $x^{R_1}\preceq y$ or $L_1$ with $x\preceq y^{L_1}$.
  %   If $x^{R_1}\preceq y$, then the outer inductive hypothesis implies $x^{R_1}\prec z$, hence $x^{R_1}\preceq z$, and thus $x\prec z$.
  %   And if $x\preceq y^{L_1}$, then the inner inductive hypothesis applied to $y^{L_1}<y^{R_0}$ (which comes from $y$ being defined as a cut) and $y^{R_0}\le z$ yields $x\prec z$.
  \end{itemize}
  This completes the inner induction.
  Thus, for any $x$ defined by a cut, we have $(x\prec -)$ and $(x\preceq -)$ defined by~\eqref{eq:NO-preceq-def} and~\eqref{eq:NO-prec-def}, and transitive on the right.

  To complete the outer recursion, we need to verify these definitions are transitive on the left.
  After a $\NO$-induction on $z$, we end up with three cases that are essentially identical to those just described above for transitivity on the right.
  Hence, we omit them.
\end{proof}

\begin{thm}\label{thm:NO-encode-decode}
  For any $x,y:\NO$ we have $(x<y)=(x\prec y)$ and $(x\le y)=(x\preceq y)$.
\end{thm}
\begin{proof}
  From left to right, we use $(\NO,\le,<)$-induction where $A(x)\defeq\unit$, with $\preceq$ and $\prec$ supplying the relations $\ble$ and $\blt$.
  In all the constructor cases, $x$ and $y$ are defined by cuts, so the definitions of $\preceq$ and $\prec$ evaluate, and the inductive hypotheses apply.

  From right to left, we use $\NO$-induction to assume that $x$ and $y$ are defined by cuts.
  But now the definitions of $\preceq$ and $\prec$, and the inductive hypotheses, supply exactly the data required for the relevant constructors of $\le$ and $<$.
  % From right to left, we first prove by $\NO$-induction on $x$ that for any $y:\NO$ we have $(x\prec y) \to (x<y)$ and $(x\preceq y) \to (x\le y)$.
  % Thus, we assume this to be true for all $x^L$ and $x^R$ in a cut, and show it for the resulting $x:\NO$.
  % Next, we prove by $\NO$-induction on $y$ that $(x\prec y) \to (x<y)$ and $(x\preceq y) \to (x\le y)$, hence we assume it to be true for all $y^L$ and $y^R$ in a cut, and show it for the resulting $y:\NO$.
  % Now since $x$ and $y$ are both defined by cuts, $x\preceq y$ means that $x^L\prec y$ and $x\prec y^R$ for all $L$ and $R$.
  % By the inductive hypotheses, this gives $x^L<y$ and $x<y^R$, hence $x\le y$ by the constructor of $\le$.
  % Similarly, $x\prec y$ yields merely an $R_0$ with $x^{R_0}\preceq y$ or an $L_0$ with $x\preceq y^{L_0}$.
  % Hence merely $x^{R_0}\le y$ or $x\le y^{L_0}$ by the inductive hypothesis, so $x<y$ by a constructor.
\end{proof}

\begin{cor}\label{thm:NO-unstrict-transitive}
  The relations $\le$ and $<$ on $\NO$ satisfy
  \[ \fall{x,y:\NO} (x<y) \to (x\le y) \]
  and are transitive:
  \begin{gather*}
    (x\le y) \to (y\le z) \to (x\le z)\\
    (x\le y) \to (y< z) \to (x< z)\\
    (x< y) \to (y\le z) \to (x< z).
  \end{gather*}
\end{cor}

As with the Cauchy reals, the joint $(\NO,\le,<)$-recursion principle remains essential when defining all operations on $\NO$.

\begin{eg}
We define $\mathord+:\NO\to\NO\to\NO$ by a double recursion.
For the outer recursion, we take the codomain to be the subset of $\NO\to\NO$ consisting of functions $g$ such that $(x<y) \to (g(x)<g(x))$ and $(x\le y) \to (g(x)\le g(y))$ for all $x,y$.
For such $g,h$ we define $(g\ble h)\defeq \fall{x:\NO} g(x)\le h(x)$ and $(g\blt h)\defeq \fall{x:\NO} g(x)< h(x)$.
Clearly $\ble$ is antisymmetric.

For the primary clause of the recursion, we suppose $x$ defined by a cut, and we define $(x+\blank)$ by an inner recursion on $\NO$ with codomain $\NO$, with relations $\bble$ and $\bblt$ coinciding with $\le$ and $<$.
For the primary clause of the inner recursion, we suppose also $y$ defined by a cut, and give Conway's definition:
\[ x+y \defeq \surr{x^L+y, x+y^L}{x^R+y,x+y^R}. \]
In other words, the left options of $x+y$ are all numbers of the form $x^L+y$ for some left option $x^L$, or $x+y^L$ for some left option $y^L$.
The presence of the options $x^L+y$ and $x^R+y$ in $x+y$ implies directly that $x+y \in A'(y)$.
Now we verify that this definition preserves inequality:
\begin{itemize}
\item If $y\le z$ arises from knowing that $y^L<z$ and $y<z^R$ for all $L$ and $R$, then the inner inductive hypothesis gives $x+y^L<x+z$ and $x+y < x+z^R$, while the outer inductive hypotheses give $x^L+y < x^L+z$ and $x^R+ y < x^R+z$.
  And since each $x^L+z$ is by definition a left option of $x+z$, we have $x^L+z < x+z$, and similarly $x+y < x^R+y$.
  Thus, using transitivity, $x^L+y < x+z$ and $x+y < x^R+z$, and so we may conclude $x+y \le x+z$ by the constructor of $\le$.
\item If $y<z$ arises from an $L_0$ with $y\le z^{L_0}$, then inductively $x+y \le x+z^{L_0}$, hence $x+y<x+z$ since $x+z^{L_0}$ is a right option of $x+z$.
\item Similarly, if $y<z$ arises from $y^{R_0}\le z$, then $x+y<x+z$ since $x+y^{R_0}\le x+z$.
\end{itemize}
This completes the inner recursion.
For the outer recursion, we have to verify that $+$ preserves inequality on the left as well.
After an $\NO$-induction, this proceeds in exactly the same way.
\end{eg}

In the Appendix to Part Zero of~\cite{conway:onag}, Conway discusses how the surreal numbers may be formalized in ZFC set theory: by iterating along the ordinals and passing to sets of representatives of lowest rank for each equivalence class, or by representing numbers with ``sign-expansions''.
He then remarks that
\begin{quote}\footnotesize
  The curiously complicated nature of these constructions tells us more about the nature of formalizations within ZF than about our system of numbers\dots
\end{quote}
and goes on to advocate for a general theory of ``permissible kinds of construction'' which should include
\begin{enumerate}\footnotesize
\item Objects may be created from earlier objects in any reasonably constructive fashion.\label{item:conway1}
\item Equality among the created objects can be any desired equivalence relation.\label{item:conway2}
\end{enumerate}
\noindent
Condition~\ref{item:conway1} can be naturally read as justifying general principles of \emph{inductive definition}, such as those presented in \autoref{sec:strictly-positive,sec:generalizations}.
In particular, the condition of strict positivity for constructors can be regarded as a formalization of what it means to be ``reasonably constructive''.
Condition~\ref{item:conway2} then suggests we should extend this to \emph{higher} inductive definitions of all sorts, in which we can impose path-constructors making objects equal in any reasonable way.
For instance, in the next paragraph Conway says:
\begin{quote}\footnotesize
  \dots we could also, for instance, freely create a new object $(x,y)$ and call it the ordered pair of $x$ and $y$.
  We could also create an ordered pair $[x,y]$ different from $(x,y)$ but co-existing with it\dots
  If instead we wanted to make $(x,y)$ into an unordered pair, we could define equality by means of the equivalence relation $(x,y)=(z,t)$ if and only if $x=z,y=t$ \emph{or} $x=t,y=z$.
\end{quote}
The freedom to introduce new objects with new names, generated by certain forms of constructors, is precisely what we have in the theory of inductive definitions.
Just as with our two copies of the natural numbers $\nat$ and $\nat'$ in \autoref{sec:appetizer-univalence}, if we wrote down an identical definition to the cartesian product type $A\times B$, we would obtain a distinct product type $A\times' B$ whose canonical elements we could freely write as $[x,y]$.
And we could make one of these a type of unordered pairs by adding a suitable path-constructor. % (and perhaps 0-truncating).

To be sure, Conway's point was not to complain about ZF in particular, but to argue against all foundational theories at once:
\begin{quote}\footnotesize
  \dots this proposal is not of any particular theory as an alternative to ZF\dots{}
  What is proposed is instead that we give ourselves the freedom to create arbitrary mathematical theories of these kinds, but prove a metatheorem which ensures once and for all that any such theory could be formalised in terms of any of the standard foundational theories.
\end{quote}
One might respond that, in fact, Univalent Foundations is not one of the ``standard foundational theories'' which Conway had in mind, but rather the \emph{metatheory} in which we may express our ability to create new theories, and about which we may prove Conway's metatheorem.
For instance, the surreal numbers are one of the ``mathematical theories'' Conway has in mind, and we have seen that they can be constructed and justified inside Univalent Foundations.
Similarly, Conway remarked earlier that
\begin{quote}\footnotesize
  \dots set theory would be such a theory, sets being constructed from earlier ones by processes corresponding to the usual axioms, and the equality relation being that of having the same members.
\end{quote}
This description closely matches the higher-inductive construction of the cumulative hierarchy of set theory in \autoref{sec:cumulative-hierarchy}.
Conway's metatheorem would then correspond to the fact we have referred to several times that we can construct a model of Univalent Foundations inside ZFC (which is outside the scope of this book).

However, Univalent Foundations is so rich and powerful in its own right that it would be foolish to relegate it to only a metatheory in which to construct set-like theories.
We have seen that even at the level of sets (0-types), the higher inductive types in Univalent Foundations yield direct constructions of objects by their universal properties (\autoref{sec:free-algebras}), such as a constructive theory of Cauchy completion (\autoref{sec:cauchy-reals}).
But most importantly, the potential to model homotopy theory and category theory directly in the foundational system (\autoref{cha:homotopy,cha:category-theory}) gives Univalent Foundations an advantage which no set-theoretic foundation can match.


\sectionNotes

In traditional constructive mathematics constructions of real numbers always seem to
require certain compromises. For example, the Dedekind reals do not work well without
powersets or some other form of impredicativity, while Cauchy reals work well in the
presence of Countable Choice. It seems that with our construction of Cauchy reals as a
higher inductive-inductive type we found a third possibility, which requires neither
powersets nor Countable Choice.

Richman~\cite{Richman:reals} develops the Dedekind real numbers constructively.
He defines multiplication first on the positive cuts and then extends it algebraically to all Dedekind cuts.

The fact that $\RC$ is the least Cauchy complete archimedean ordered field, as was proved
in \autoref{RC-initial-Cauchy-complete}, indicates that our Cauchy reals coincide with
those of~\cite{EscardoSimpson:01}.

It is constructive folklore that coincidence of Cauchy and Dedekind reals requires
\define{Dependent Choice}, which states that, for any set $A$, a total relation $R : A
\times A \to \prop$, and $a : A$ there exists $f : \N \to A$ such that $f(0) = a$ and
$R(f(n), f(n+1))$ for all $n : \N$. Our \autoref{when-reals-coincide} is a slight
improvement because Countable Choice is weaker than Dependent Choice. In any case, none of
these observations are new.

The intricate relationship between various notions of compactness in a constructive
setting is discussed in \cite{bridges2002compactness}.


\dots

The surreal numbers were defined by~\cite{conway:onag}, using a sort of inductive definition but without justifying it explicitly in terms of any foundational system.
For this reason, some later authors have tended to use sign-expansions or other more explicit presentations which can be coded more obviously into set theory.
The idea of representing them in type theory was first considered by Hancock, while
Setzer and Forsberg noted that the surreals and their inequality relations $<$ and $\le$ naturally form an inductive-inductive definition.
The \emph{higher} inductive-inductive version presented here, which builds in the correct notion of equality for surreals, is new.


\sectionExercises

\begin{ex} \label{ex:RD-extended-reals}
  %
  Suppose we remove the boundedness condition in \autoref{defn:dedekind-reals}.
  Then we obtain the \define{extended reals} which contain $-\infty \defeq
  (\emptyset, \Q)$ and $\infty \defeq (\Q, \emptyset)$. Which definitions of arithmetical
  operations on cuts still make sense for extended reals? What algebraic structure do we
  get?
\end{ex}

\begin{ex} \label{ex:RD-lower-cuts}
  %
  By considering one-sided cuts we obtain \define{lower} and \define{upper} Dedekind reals,
  respectively. For example, a lower real is given by a predicate $L : \Q \to \Omega$
  which is
  %
  \begin{enumerate}
  \item \emph{bounded:} $\exis{q : \Q} L(q)$ and
  \item \emph{rounded:} $L(q) = \exis{r : \Q} q < r \land L(r)$.
  \end{enumerate}
  %
  (We could also require $\exis{r : \Q} \lnot L(r)$ to exclude the cut $\infty \defeq
  \Q$.) Which arithmetical operations can you define on the lower reals? In particular,
  what happens with the additive inverse?
\end{ex}

\begin{ex} \label{ex:RD-interval-arithmetic}
  %
  Suppose we remove the locatedness condition in \autoref{defn:dedekind-reals}.
  Then we obtain the \define{interval domain} $\mathbb{I}$ because cuts are allowed
  to have ``gaps'', which are just intervals. Define the partial order $\sqsubseteq$ on
  $\mathbb{I}$ by
  %
  \begin{equation*}
    ((L, U) \sqsubseteq (L', U'))
    \defeq
    (\fall{q : \Q} L(q) \Rightarrow L'(q)) \land
    (\fall{q : \Q} U(q) \Rightarrow U'(q)).
  \end{equation*}
  %
  What are the maximal elements of $\mathbb{I}$ with respect to $\mathbb{I}$? Define the
  ``endpoint'' operations which assign to an element of the interval domain its lower and
  upper endpoints. Are the endpoints reals, lower reals, or upper reals (see
  \autoref{ex:RD-lower-cuts})? Which definitions of arithmetical operations on cuts still
  make sense for the interval domain?
\end{ex}

\begin{ex} \label{ex:RD-lt-vs-le}
  Show that, for all $x, y : \RD$,
  %
  \begin{equation*}
    \lnot (x < y) \Rightarrow y \leq x
  \end{equation*}
  %
  and
  %
  \begin{equation*}
    \eqv{(x \leq y)}{\prd{\epsilon : \Qp} x < y + \epsilon}.
  \end{equation*}
  %
  Does $\lnot (x \leq y)$ imply $y < x$?
\end{ex}

\begin{ex} \label{ex:reals-non-constant-into-Z}
  \mbox{}
  %
  \begin{enumerate}
  \item 
    Assuming excluded middle, construct a non-constant map $\RD \to \Z$.
  \item 
    Suppose $f : \RD \to \Z$ is a map such that $f(0) = 0$ and $f(x) \neq 0$ for all $x >
    0$. Derive from this the Limited Principle of Omniscience~\eqref{eq:lpo}.
  \end{enumerate}
\end{ex}

\begin{ex} \label{ex:traditional-archimedean}
  Show that in an ordered field $F$ density of $\Q$ and the traditional archimedean axiom
  are equivalent:
  %
  \begin{equation*}
    (\fall{x, y : F} x < y \Rightarrow \exis{q : \Q} x < q < y)
    \Leftrightarrow
    (\forall{x : F} \exis{k : \Z} x < z).
  \end{equation*}  
\end{ex}

\begin{ex} \label{RC-Lipschitz-on-interval} Suppose $a, b : \Q$ and $f : \setof{ q : \Q |
    a \leq q \leq b } \to \RC$ is Lipschitz with constant~$L$. Show that there exists a unique
  extension $\bar{f} : [a,b] \to \RC$ of $f$ which is constant with Lipschitz
  constant~$L$. Hint: rather than redoing \autoref{RC-extend-Q-Lipschitz} for closed
  intervals, observe that there is a retraction $r : \RC \to [-n,n]$ and apply
  \autoref{RC-extend-Q-Lipschitz} to $f \circ r$.
\end{ex}

\begin{ex} \label{ex:reals-apart-neq-MP}
  \define{Markov principle} says that for all $f : \nat \to \bool$,
  %
  \begin{equation*}
    (\lnot \lnot \exis{n : \nat} f(n) = \btrue)
    \Rightarrow
    \exis{n : \nat} f(n) = \btrue.
  \end{equation*}
  %
  This is a particular instance of the law of double negation~\eqref{eq:ldn}. Show that
  $\fall{x, y: \RD} x \neq y \Rightarrow x \apart y$ implies Markov principle. Does the
  converse holds as well?
\end{ex}

\begin{ex} \label{ex:reals-apart-zero-divisors}
  Verify that the following ``no zero divisors'' property holds for the real numbers:
  $x y \apart 0 \Leftrightarrow x \apart 0 \land y \apart 0$.
\end{ex}

\begin{ex} \label{ex:finite-cover-lebesgue-number}
  %
  Suppose $(q_1, r_1), \ldots, (q_n, r_n)$ pointwise cover $(a, b)$. Then there is
  $\epsilon : \Qp$ such that whenever $a < x < y < b$ and $|x - y| < \epsilon$
  then there merely exists $i$ such that $q_i < x < r_i$ and $q_i < y < r_i$. Such an
  $\epsilon$ is called a \define{Lebesgue number} for the given cover.
\end{ex}

\begin{ex} \label{ex:mean-value-theorem}
  %
  Prove the following approximate version of Mean Value Theorem:
  %
  \begin{quote}
    \emph{
      If $f : [0,1] \to \R$ is uniformly continuous and $f(0) < 0 < f(1)$ then
      for every $\epsilon : \Qp$ there merely exists $x : [0,1]$ such that $|f(x)| <
      \epsilon$.
    }
  \end{quote}
  %
  Hint: do not try to use the bisection method because it leads to the axiom of choice.
  Instead, approximate $f$ with a piece-wise linear map. How do you construct a piece-wise
  linear map?
\end{ex}

\begin{ex}
  Check whether everything in~\cite{knuth74:_surreal_number} can be done using the higher
  inductive-inductive surreals of \autoref{sec:surreals}.
\end{ex}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "main"
%%% End: 
